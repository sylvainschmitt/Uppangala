---
title: Functional assembly into and among community of a tropical evergreen forest
  from Western Ghats, India
author: "Sylvain Schmitt sylvain.schmitt@agroparistech.fr"
date: '`r Sys.Date()`'
output: word_document
bibliography: refs.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
library(parallel)
cores <- detectCores() - 1
library(Uppangala)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
  cache = T, cache.lazy = F)
```

Built with `Uppangala` package version `r packageVersion('Uppangala')`.

# Abstract

## Keywords

functional trait; tropical evergreen forest; Western Ghats; India...

# Introduction

Ecology offers different theories describing community composition of tropical forest. Niche theory invoke ecological filtering responsible for species assembly inside communities [@chave_comparing_2002]. On the other hand neutral theory [@hubbell_neutral_2005] assume functional equivalence of species, implying species distributions shaped by stochastic events as dispersion and death. @lortie_rethinking_2004 offered a conceptual framewok that reconciliates the two approach by defining integrated community concept. Integrated communities are build on three levels: $\gamma$ diversity as the initial regional species pool filtered by stochastic neutral events, $\beta$ diversity between communities resulting from abiotic filtering and stochastic events among communities, and $\alpha$ diversity defining the community assembly after local abiotic and biotic filtering.

Communities are composed from species spanning a range of functional traits responsible for their growth, survival and reproduction. Functional traits can thus be linked to trade-offs representative of species ecological strategies. For instance, specific leaf area varies along a soil fertility - shade index representative of a trade-off between ressource acquisition by photosynthesis and leaf investment in defense and leaf lifespan [@hodgson_is_2011]. Due to common ecological strategies, functional traits will covary in so called economic spectra. @wright_worldwide_2004 discovered the leaf economic spectrum followed by the wood economic spectrum of @chave_towards_2009. The leaf economic spectrum opposes productive ecological strategy to conservative persistent species. The wood economic spectrum is separating species between three pole close to @grime_evidence_1977 primary strategy axes: (i) competitive species, with high conductive efficiency, (ii) stress tolerant species, resistant to embolism, and (iii) disturbance tolerant species, with high mechanical strength. A debated question is links between species economic spectra and strategy axes. Whereas @baraloto_decoupled_2010 highlighted decoupled economic spectra allowing tree species to adjust differently their ecological strategies; @reich_world-wide_2014 advocate more for a whole plant economic spectrum identified by @freschet_evidence_2010 opposing fast growing species to more conservative ones. Stochastic process and environmental filtering will be highly scale dependent. Effectively some functional traits will be more variable at the individual level with plasticity to micro-environmental conditions whereas others will be more affected on global environmental gradient with phylogeny. For instance, @messier_trait_2016 argued the scale to which traits are covarying in ecological strategy, more especially they question the existence of the leaf economic spectrum at community scale.

Functional traits in community ecology are linking ecological strategies, community assembly theory and functional diversity [@westoby_land-plant_2006]. In this paper we present the use of traits-based approach combined to community ecology to encompass functional assembly into and among community of a tropical evergreen forest from Western Ghats, India. Few studies investigated functional ecology whithin the Western Ghats indian biodiversity hotspot [@myers_biodiversity_2000]. Western Ghats present atypic moist tropical evergreen forest though seasonnaly dry and afffected by strong monsoon events. Such environmental conditions can be highly interesting to discuss and evaluate community assembly theory resulting in functional assembly of those forests. To do so we organised our study framework in two main questions :

1. Do variations and covariations in functional traits reflect distinct ecological strategies within and among species ?
    i. Do and how functional traits vary among species ?
    ii. Do covariations in functional traits represent axes of ecological strategy within species ?
2. Does functional composition reflect the influence of local abiotic and biotic drivers of community dynamics ?
    i. Do local functional composition ($\alpha$ scale) reflect the influence of abiotic and biotic drivers of community dynamics ?
    ii. Do functional composition variation between communities ($\beta$ scale) reflect the changing of abiotic and biotic conditions ?

# Material and methods

## Study site

The study was carried out in the the 10-ha "Uppangala plot" of undisturbed, old-growth wet evergreen Diptrocarp forest. The plot is located in the Kadamakal Reserve Forest (Kodagu District, Karnataka State, India) in India's Western Ghats biodiversity hotspot. Climate is characterized by a peak of heavy rainfall during monsoon and a marked dry season. Annual precipitation averages 5108 mm with 90% between June and October and an average dry season (monthly rainfall $\leq 45$ mm) of 3.8 months [@pelissier_twenty_2011]. Mean annual temperature in the station of Sampaji (15 km from Uppangala) is about 27$^\circ C$, with a mean minimum about 25$^\circ C$ during July rainfall pick and a maximum mean temperature of 29$^\circ C$ in April [@pascal_structure_1996]. Climate and geology of the 10-ha plot can be considered as homogeneous. General topography of the site shows a regular east-west alternation between thalwegs and ridges separated by relatively steep slopes, so that topography can be assumed as the major local abiotic factor which varies inside the plot [@gimaret-carpentier_sampling_1998]. The permanent plot was established in 1990 by the French Institute of Pondicherry and described by @pascal_structure_1996. Since 1989, all trees $\geq 30$ cm girth at breast height (gbh) were monitored in an area progressively extended to 10ha in 2014. All trees were identified, tagged, mapped, and provided with permanent dendrometer bands censused every 2-5 years.

## Wood and leaf sampling

We collected trait data on 89 over 111 (80.1%) species. The 32 most abundant species represent more than 80% of Uppangala tree individuals.
We sampled five individuals per species for most abundant species and we completed with less abundant and rare species with one to five individuals (in total of 267 individuals).  Thus we got trait data for 99.0% of the tree individuals present in the Uppangala plot. For each individual we collected 6 mature shadow leaves and one branch sample with a diameter close to 1 cm following recommendation from @perez-harguindeguy_new_2013. Individuals and leaves were selected in consistent light condition, development stage and sanitary state. Dawkins crown exposure index [@dawkins_management_1958] was assessed for each tree sampled. Leaf and branch samples were kept in humidified ziplock filled with enriched CO2 air inside a black bag untill their measurement in the following 24 hours. For some individuals, we were unable to collect an appropriate branch sample (58 over 267 individuals representing 11 missing species over 89 accounitg for 1% of individuals present in the 10ha plot).

## Trait measurements

Leaf petioles, rachis and petiolules were removed for all measurements. Leaf fresh weights, area and thickness were measured, using a bend scanner and a micrometer. Leaves were first kept in herbarium and then dried in an oven for at least 72 hours at 60 $^\circ C$, the drying process was stopped after dry leaf weights were stable in time. Once dried, the leaves were weighted directly after been extracted from the oven to avoid humidity bias. The bark and pit of branch samples were removed in order to keep only branch wood with no soft tissues. Branch wood samples were sink in water to evaluate their volume by water displacement. Samples were then dried for 48 hours at 80 degrees celsius and weighted. 

We calculated five functional traits of leaf and wood samples: leaf thickness (Thick in $\mu m$ ), leaf area measured from scans (LA in $mm^2$), leaf dry matter content as the leaf dry weight divided by the leaf fresh weight (LDMC in $mg.g^-1$), specific leaf area as the leaf area divided by the leaf dry mass (SLA in $m^2.kg^-1$), and branch wood density  as the the wood sample dry weight divided by its volume (WD in $g.cm^-3$, see table 1). 

Table 1: Functional traits measured. *Traits with their abbreviation, range of values in the sampling, mean and standard deviation, standard unit, and associated trade-off in tree strategy for functionning, survival and reproduction from @baraloto_decoupled_2010.*

```{r 1 Traits}
rm(list = ls()[-which(ls() == "cores")]); invisible(gc())
PFT <- genPFT()
table <- data.frame(
  Trait = c('Thickness', 'Leaf area', 'Leaf dry matter content', 'Specific leaf area', 'Wood density'),
  Abbreviation = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'),
  Range = c(paste(range(PFT$Thick, na.rm = T), collapse = '-'),
            paste(round(range(PFT$LA, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$LDMC, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$SLA, na.rm = T), 2), collapse = '-'),
            paste(round(range(PFT$WD, na.rm = T), 2), collapse = '-')),
  m = c(paste0(round(mean(PFT$Thick, na.rm = T)), ' (',
                         round(sd(PFT$Thick, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LA, na.rm = T)), ' (',
                         round(sd(PFT$LA, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LDMC, na.rm = T)), ' (',
                         round(sd(PFT$LDMC, na.rm = T)), ')'),
                  paste0(round(mean(PFT$SLA, na.rm = T),2), ' (',
                         round(sd(PFT$SLA, na.rm = T),2), ')'),
                  paste0(round(mean(PFT$WD, na.rm = T),2), ' (',
                         round(sd(PFT$WD, na.rm = T),2), ')')),
  Unit = c('$\\mu m$', '$mm^2$', '$mg.g^-1$', '$m^2.kg^-1$', '$g.cm^-3$'),
  s = c('Leaf defense vs. investment',
               'Leaf ressource capture vs.investment',
               'Leaf defense vs. investment',
               'Leaf ressource acquisiton vs. defense',
               'Stem transport, structure and defense')
  )
names(table)[c(4,6)] <- c('Mean (sd)', 'Trade-off')
kable(table, row.names = F)
rm(table)
```

## Environmental variables

We selected 8 topographical variables representing abiotic factors: digital elevation model, slope, curvature, plan curvature, profile curvature, wetness (function of both slope and elevation representing water flow and accumulation areas), southwesterness (SW, aspect in direction of south-west), and distance to the nearest potential river. Digital elevation model was provided by a 2013 LIDAR campaign on Uppangala plots with a resolution of $1*1 m^2$. Slope, curvature, plan curvature, profile curvature, wetness and southwesterness ($cos(aspect~in~degres + 225)$) were all derived from the digital elevation model using the RSAGA package [@brenning_statistical_2008]. Distance to the nearest potential river was computed using ArcGis [@desktop_arcgis_2011].

In order to identify main source of environmental variation and to avoid multi-colinearity in future analyses, we reduced our abiotic explanatory variables via a principal component analysis (PCA). We selected less correlated variables with the most ecological meaning. Thus we reduced our explanatory variables to 4: curvature to represent the water flow paths and soil accumulation areas, wetness to highlight water accumulation areas, southwesterness to represent aspect [@bunyan_effect_2015] and slope.

We selected two biotic factors related to local forest structure: canopy height and basal area. Canopy height was calculated from a digital canopy model built with the 2013 LIDAR campaign on Uppangala plots with resolution $1*1 m^2$. Basal area was calculated from 2013 girth inventory of Uppangala plot on stems with a diameter above 10 centimeters at breast height ($DBH>10~cm$). 

## Analyses

### Traits variation and covariation

The coefficient of variation of traits was investigated at three levels ($cv = \frac{\sigma}{\mu}$ with $\sigma$ the standard deviation and $\mu$ the mean): between leaves of the same individual (intra-individual), between trees of the same species (intra-specific for species with more than one individual), and between species (inter-specific). We performed a principal component analysis (PCA) of the mean value of traits per species. Subsequent community-level analysis were based on trait values averaged per species.

### Local functional composition of communities

Across the whole 10 hectare plot from Uppangala, 240 local communities where defined in $20*20 m^2$ quadrats. To investigate functional composition of communities we used a null model approach. A first null model (NM1) randomizes trait values among species (permuting raw in `Trait*Species` matrix). The second model (NM2) randomizes abundances among species inside each community but keeps the observed list of species and trait values inside communities [@bernard-verdier_community_2012]. 

To investigate local functional composition of communities we used community weighted means (CWM), community weighted variances (CWV), and coefficients of variation from the nearest neighbour distance (CVNND) [CWM and CWV, sensu @violle_let_2007; CVNND, @jung_intraspecific_2010]. CWM for each trait $t$ was calculated as the mean of species trait values, $t_{i}$, of the $S$ species in each community, with each species, $i$, weighted by its relative abundance, $p_{i}$:
$$CWM = \sum_{i=1}^{S} p_{i} * t_{i} ~ (1)$$
CWM was also computed in presence-absence, to further emphasize role of rare species in community trait distribution. Linear regressions between CWMs and biotic and abiotic factors ($CWM_{trait} = Slope + Curvature + Wetness + SW + Canopy + BA$), after stepwise selection, were compared to corresponding 999 null linear regressions from NM1 with F-statistic. 

CWV for each trait $t$ was calculated as the mean distance of trait values, $t_{i}$, to $CWM$, of the $S$ species in each community, with each species, $i$, weighted by its relative
abundance, $p_{i}$:
$$CWV = \sum_{i=1}^{S} p_{i} * (t_{i} - CWM)^2 ~ (2)$$
CVNND for each trait $t$, scaled with its mean and variance, was calculated as nearest neigbor distances (NND) standard deviation, $\sigma _{NND}$, of the $i$ individuals in each community, divided by its mean, $\mu _{NND}$; and NND for one individual $i$ is calculated as the minimal distance $d$ between the $j$ other individuals of the community :
$$CVNND = \frac{\sigma _{NND}}{\mu _{NND}} ~ , ~ ~ ~ NND = [NND_{i} = min(d_{i,j})_{i \neq j}] ~ (3)$$
For both CWV and CVNND, proportion of of communities differing from null expectaions was tested with a two-tailed test with adjusted p-values by Benjamini-Hochberg correction. CWV lower than expected under a null model will be evidence for convergence of traits inside the community whereas higher CWV will show divergence in trait distribution. CVNND is used to detect niche differenciation patterns in case of a lower CVNND as observed under a null model [@jung_intraspecific_2010]. We then calculated the standardized effect size (SES) as: $$SES = \frac{(I_{obs} - I_{null})}{\sigma _{null}} (4)$$
where $I_{obs}$ is the observed metric and $I_{null}$ and $\sigma _{null}$ are the mean and standard deviation of null distributions of NM2 and NM1 for CWV and CVNND respectively.
Effect of environment on SES was investigated by linear regression with selected biotic and abiotic factors. Analyses were conducted on the five functional traits and the species scores obtained on the 2 first PCA axes.

### Floristic, functional and phylogenetic composition between communities

Phylogenetic tree of our 89 species was built with `S.PhyloMaker` function implemented by @qian_updated_2016-1. Phylogenetic signal was globaly assessed for each functional trait among the phylogenetic tree by Moran's I statistic. Positive Moran's I value indicates convergence of trait values within the phylogeny whereas negative Moran's I will show divergence.

To investigate floristic, functional, and phylogenetic composition between communities we used $I_{st}$, for floristic composition, $U_{st}$ and $\tau _{st}$, for functional composition in abundance and presence-absence respectively, and $\beta _{st}$ and $\pi _{st}$, for phylogenetic composition in abundance and presence-absence respectively [@hardy_characterizing_2007]. 

Variation of composition between community pairs with those metrics was translated as a floristic, functional and phylogenetic distance, and compared to environmental and spatial distances among community pairs. Environmental distances were calculated as geometric distances between communities on the plan composed by the two first axes of environmental variables PCA (see supplementary material S1). Correlations with environment and space were assessed with two Mantel tests successively with floristic, functional, and phylogenetic community compositions. A firt full Mantel statistic evaluates the correlation between each metric distance matrix and the environmental distance matrix (E). The second partial Mantel statistic assess the correlation between each metric distance matrix and the spatial distance matrix knowing environmental distance matrix (E|S), representing spatial residuals that can influence community composition once the environment effect taken into account.

We used null models to test if observed correlation with Mantel statistic differed significantly from expectations under null hypothesis. $I_{st}$ correlation to environment and space was tested with 999 repetions of the model nul described by @myers_beta-diversity_2013 which randomizes individuals among subplots while preserving the regional abundance of species, and the number of individuals per community. $U st$ and $\tau st$ were tested by the nul model NM1 which randomizes traits among species. Finally $\beta st$ and $\pi st$ were tested against the nul model *"1s"* suggested by @hardy_testing_2008 which randomizes phylogenetic tree tips.


All analysis were conducted using the R 3.3.0  software environment [@r_core_team_r:_2016] with packages 
`ade4` [@dray_ade4_2007], 
`ape` [@paradis_ape:_2004], 
`phylosignal` [@keck_phylosignal:_2015], 
`spacodiR` [@eastman_spacodir:_2013],
and `vegan` [@oksanen_vegan:_2016].

# Results

## Traits variation and covariation

We found a general increase of functional trait variation from intra-individual to inter-specific level (see table 2). Whereas LA shows already high variabililty at intra-individual level almost as strong as the intra-specific variation ($CV_{individual} = 0.20$ and $CV_{species} = 0.24$, wilcoxon rank test $p-value = 0.137$). 

Table 2: Coefficient of intra-individual, intra-specific and inter-specific trait variation. *Mean of coefficient of variation for leaves in all individuals (intra-individual), for trees in all species (intra-specific), and coefficient of variation for trees for all species. See table 1 for abbreviation.*

```{r 2 CV}
PFT_ind <- aggregate(PFT, by = list(PFT$Tree), FUN = mean, na.rm = T)
row.names(PFT_ind) <- PFT_ind$Group.1
SpT <- unique(PFT[1:2])
Sp <- SpT$Sp
names(Sp) <- SpT$Tree
SpCodeT <- unique(PFT[2:3])
SpCode <- SpCodeT$SpCode
names(SpCode) <- SpCodeT$Sp
CET <- unique(PFT[c(1,4)])
CE <- CET$CE
names(CE) <- CET$Tree
PFT_ind$Sp <- Sp[row.names(PFT_ind)]
PFT_ind$SpCode <- SpCode[as.character(PFT_ind$Sp)]
PFT_ind$CE <- CE[row.names(PFT_ind)]
PFT_ind <- PFT_ind[-c(1:2)]
cv <- data.frame(row.names = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'))
cv$Individual <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT[which(names(PFT) ==  y)], by = list(PFT$Tree), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Species <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT_ind[which(names(PFT_ind) ==  y)], by = list(PFT_ind$Sp), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Community <- unlist(
  lapply(as.list(row.names(cv)),
         function(y){sd(PFT[,which(names(PFT) ==  y)], na.rm = T) /
             mean(PFT[,which(names(PFT) ==  y)], na.rm = T)}))
cv <- round(cv, 2)
cv['WD','Individual'] <- ''
kable(cv)
rm(PFT, CET, cv, CE, Sp, SpT)
```

The principal component analysis (PCA) shows WD associated with structural leaf traits orthogonal to the SLA (see figure 1). The first PCA axis (PCA1) covary mainly with Thick, LDMC and WD; opposing thin and big leaves to dense leaves and wood. PCA1 axis associates WD to leaf structural traits variation linked to hydraulic conductivity efficiency associated with the wood economic spectrum [WES, @chave_towards_2009]. Whereas the PCA2 covary mainly positively with SLA and negatively with LDMC representative of the leaf economic spectrum [LES, @wright_worldwide_2004].

```{r 3 PCA PFT}
library(vegan)

PFT_ind$LA <- log(PFT_ind$LA)
PFT_ind$SLA <- log(PFT_ind$SLA)
PFT_ind$ID <- row.names(PFT_ind)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
Species <- genSpecies()
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$Sp), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$SpCode <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
pca <- princomp(~ LA + WD + Thick + LDMC + SLA, data = PFT_sp, cor = T)

lambda <- pca$sdev * sqrt(nrow(pca$scores))
pca.var = apply(pca$score, 2, var)
PCAscores <- as.data.frame(pca$scores)[1:2]
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
plot(t(t(pca$scores)/lambda),pch=16, col = 'lightgrey',
      xlab = paste('Axe 1 -', round(pca.var[1]/sum(pca.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.var[2]/sum(pca.var)*100, 2), '%'))
par(new=T)
Rot <- t(t(pca$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, col = 'firebrick', lwd = 2)
lines(c(0,0), XLIM, lty = 2, col = 'green', lwd = 2)
legend('topright', c('Leaf economic spectrum', 'Wood economic spectrum'),
       text.col = c("green", "firebrick"))

arrows (rep(0,nrow(pca$loadings)),rep(0,nrow(pca$loadings)),Rot[,1],Rot[,2],lwd=2)
text (Rot[,1:2], pos = c(4, 2, 4, 2, 3), rownames(Rot),cex=1.2)
Hmisc::subplot(function(){
  b <- barplot((pca.var / sum(pca.var)), las = 2, ylim = c(0,range(bstick(7))[2]),
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.75,1), from='npc'),
  y=grconvertY(c(0.05,0.30), from='npc')
)
axis (3)
axis (4)

PCAscores <- as.data.frame(pca$scores)[1:2]
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
PFT_sp$ID <- row.names(PFT_sp)
PFT_sp <- merge(PFT_sp, PCAscores, all = T)
row.names(PFT_sp) <- PFT_sp$ID
PFT_sp <- PFT_sp[-which(names(PFT_sp) == 'ID')]
rm(PCAscores, PFT_ind, SpCodeT, lambda, pca, pca.var, Rot, XLIM)
```

Figure 1: Principal component analysis (PCA) performed on species trait means. *Bottom right corner subplot represents the eigen values (grey bars) compare to a broken stick distribution for 5 components (red line). See table 1 for abbreviation.*

```{r 4 env-com}
library(raster)
Env <- genEnv()
Trees <- genTrees()
Trees$ID <- row.names(Trees)
Trees <- merge(Trees, PFT_sp)
row.names(Trees) <- Trees$ID
Trees <- Trees[-which(names(Trees) == 'ID')]
com <- quadrats()
XY <- Trees[c('x', 'y')]
coordinates(XY) <- ~ x + y
proj4string(XY) <- crs(com)
Trees$com <- (XY %over% com)[,1]
com@data$Elevation <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 'Elevation'), c('slope', 'curvature', 'plancurvature', 'profcurvature', 'cosaspect'))
names(Deriv)[5] <- 'SW'
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
com@data$Wetness <- extract(DEMderiv(Env$DEM, 'wetness'), as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$Canopy <- extract(Env$Canopy, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
BA <- aggregate(Trees$Girth, list(Trees$com), function(x){sum(pi*(x/(2*pi))^2, na.rm = T)})
com@data$BA <- BA$x[match(com@data$id, BA$Group.1)]
pca.env <- princomp(~ Elevation + Slope + Curvature + PlanCurvature + ProfileCurvature + Wetness + SW, data = com@data, cor = T)
R <- com@data[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')]
row.names(R) <- com@data$id
L <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
L[is.na(L)] <- 0
Q <- PFT_sp[c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'Thick')]
row.names(Q) <- PFT_sp$SpCode
sel <- intersect(row.names(Q), names(L))
Q <- Q[sel,]
L <- L[sel]
R <- R[row.names(L),]
L <- list(abundance = L, `presence-absence` = L)
L$`presence-absence`[L$`presence-absence` > 1]  <- 1
rm(Deriv, XY, com, Env, Trees, sel, BA)
```

## Local functional composition of communities

Community weighted means (CWM) only show few significant trends along environmental gradients (see table 3). CWMs reveal that local mean WD will significantly increase under south-west; whereas SLA and LA, in presence-absence only, tend to decrease with curvature. In addition, LDMC in presence-absence is decreasing with canopy height.

Table 3: Summary of linear regressions and null models for CWMs of traits. _Linear regression results for each trait CWMs weighted by species relative abundance (AB) and presence-absence (PA) after a variable stepwise selection with slope, curvature, wetness, southwesterness (SW), canopy height (Canopy) and basal area (BA). Linear regressions global and partial F-statistics were compared to 999 null linear regressions built with null model NM1 which randomizes traits among species. See table 1 for abbreviations. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r CWM}
# Observed CWMs
CWM <- lapply(L, function(l){lapply(as.list(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'Thick')), function(v){apply(l, 1, function(x){weighted.mean(Q[,v], x, na.rm=T)})})})
CWM <- lapply(CWM, function(x){names(x) <- c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'Thick') ; return(x)})
## Regressions
reg <- paste('~', paste(names(R), collapse = ' + '))
CWM.lm <- lapply(CWM, function(x){lapply(x, function(y){lm(y ~., R)})})
CWM.lm <- lapply(CWM.lm, function(y){lapply(y, function(x){step(x, direction = 'both', trace = 0)})})
## Global F
Fval <- lapply(CWM.lm, function(y){lapply(y, function(x){summary(x)$fstatistic['value']})})
Fval <- lapply(Fval, function(x){do.call('rbind.data.frame', x)})
Fval <- data.frame(Fval)
names(Fval) <- names(CWM.lm)
## Partial F
pFval <- lapply(CWM.lm, function(y){lapply(y, function(x){car::Anova(x)['F value']})})

# Simulated CWMs
n = 999
nQ <- rep(list(Q), n)
nQ <- lapply(nQ, function(x){row.names(x) <- sample(row.names(x)) ; return(x)})
nQ <- lapply(nQ, function(x){x[names(L$abundance),]})
cl <- makeCluster(cores)
clusterExport(cl, list('L', 'nQ'))
nCWM <- clusterApply(cl, L, function(l){
  lapply(nQ, function(q){
    lapply(as.list(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'Thick')), function(v){
      apply(l, 1, function(x){
        weighted.mean(q[,v], x, na.rm=T)
      })
    })
  })
})
stopCluster(cl)
rm(cl)
nCWM <- lapply(nCWM, function(y){lapply(y,function(x){names(x) <- c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'Thick') ; return(x)})})
## Regressions
nCWM.lm <- mapply(function(x,y){
  lapply(y, function(z){
    mapply(function(r,s){
      lm(formula(paste0('s ~ ', as.character(r$terms)[3])), cbind(s,R))
    }, r = x, s = z, SIMPLIFY = F)
  })
}, x = CWM.lm, y = nCWM, SIMPLIFY = F)
rm(nCWM) ; invisible(gc())
## Global F
nFval <- lapply(nCWM.lm, function(lm){lapply(lm, function(y){lapply(y, function(x){summary(x)$fstatistic['value']})})})
nFval <- lapply(nFval, function(x){lapply(x, `[`, names(x[[1]])) ; apply(do.call(rbind, x), 2, as.list)})
nFval <- lapply(nFval, function(f){lapply(f, unlist)})
pval <- 1 - mapply(function(x,y){mapply(function(r,s){rank(c(r,s))[1]/(n+1)}, r = x, s= y)}, x = lapply(as.list(Fval), as.list), y = nFval)
row.names(pval) <- row.names(Fval)
rm(Fval, nFval)
# Partial F
npFval <- lapply(nCWM.lm, function(lm){lapply(lm, function(y){lapply(y, function(x){car::Anova(x)['F value']})})})
npFval <- lapply(npFval, function(x){lapply(x, `[`, names(x[[1]])) ; apply(do.call(rbind, x), 2, as.list)})
npFval <- lapply(npFval, function(f){lapply(f, function(x){do.call('cbind', x)})})
ppval <- mapply(function(x,y){mapply(function(r,s){mapply(function(p,q){rank(c(p,q))[1]/(n+1)}, p = as.list(data.frame(t(r))), q = as.list(data.frame(t(s))))}, r = x, s = y)}, x = pFval, y = npFval, SIMPLIFY = F)
ppval <- lapply(ppval, function(y){lapply(y, function(x){data.frame(t(x))})})
ppval <- lapply(ppval, function(y){data.frame(data.table::rbindlist(y, fill = T))})
ppval <- lapply(ppval, function(y){row.names(y) <- names(CWM.lm$abundance) ; return(y)})
ppval$abundance <- ppval$abundance[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy')]
ppval$abundance$BA <- NA
ppval$`presence-absence` <- ppval$`presence-absence`[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')]
ppval <- lapply(ppval, function(x){1 - x})
rm(pFval, npFval)

# Result tables
t1 <- regression_table(CWM.lm[[1]], reg, pval[,1], ppval[[1]])
t1 <- cbind(c('AB', rep(' ', length(t1[,1])-1)), t1)
names(t1)[1] <- ' '
t2 <- regression_table(CWM.lm[[2]], reg, pval[,2], ppval[[2]])
t2 <- cbind(c('PA', rep(' ', length(t2[,2])-1)), t2)
names(t2)[1] <- ' '
kable(bold(rbind(t1,t2)), row.names = F)
rm(CWM.lm, nCWM.lm, pval, ppval, reg, t1, t2) ; invisible(gc())
```

Traits divergence is measured with community weighted variances (CWV). Overall, observed CWVs doesn't differ from null expectations for all traits at the exception of one community for WD (over 240 communities). Still we can observe some trends between standardized effect size (SES) of CWVs and environment (see table 4). Effectively south-west orientation will make local functional composition of communities converge towards a mean LES and LDMC whereas LA will diverge inside community under south-west orientation. LA and LDMC values will also diverge with increasing curvature. Observed CVNNDs doesn't reveal niche differenciation among communities for all traits. Still we can observe some trends between standardized effect size (SES) of CVNNDs and environment (see table 4). Species tend to differentiate their LA with lower curvature and wetness and their WD opppositely to SouthWest orientation.

Table 4: Summary of linear regressions for traits standardized effect size (SES) of CWVs and CVNNDs. _Linear regression results for each trait SES of CWVs and CVNNDs after a variable stepwise selection with slope, curvature, wetness southwesterness (SW), canopy height (Canopy) and basal area (BA). See table 1 for abbreviations. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r CWV}
# Observed CWVs
CWV <- lapply(names(CWM$abundance), function(v){apply(cbind(data.frame(CWM$abundance[[which(names(CWM$abundance) == v)]]),L$abundance), 1, function(x){sqrt(weighted.mean((Q[,v]-x[1])^2, x[-1], na.rm=T))})})
names(CWV) <- names(CWM$abundance)

# Simulated CWVs 
nL <- rep(list(L$abundance), n)
nL <- lapply(nL,function(l){apply(l, 1, function(x){x[x != 0] <- sample(x[x != 0]) ; return(x)})}) 
nL <- lapply(nL, function(x){t(x)})
nL <- lapply(nL, data.frame)

cl <- makeCluster(cores)
clusterExport(cl, list('nL', 'CWM', 'Q'))
nCWM.cwv <- clusterApply(cl, nL, function(l){
  lapply(as.list(names(CWM$abundance)), function(v){
    apply(l, 1, function(x){
      weighted.mean(Q[,v], x, na.rm=T)
    })
  })
})
stopCluster(cl)
nCWM.cwv <- lapply(nCWM.cwv, function(x){names(x) <- names(CWM$abundance) ; return(x)})
nCWV <- mapply(function(l,cwm){
  lapply(names(CWM$abundance), function(v){
    apply(cbind(data.frame(cwm[[which(names(cwm) == v)]]),l), 1, function(x){
      sqrt(weighted.mean((Q[,v]-x[1])^2, x[-1], na.rm=T))
    })
  })
}, l = nL, cwm = nCWM.cwv, SIMPLIFY = F)
nCWV <- lapply(nCWV, function(x){names(x) <- names(CWM$abundance) ; return(x)})
rm(nCWM.cwv, cl, nL) ; invisible(gc())
## Non null CWVs
nCWV <- lapply(nCWV, `[`, names(nCWV[[1]]))
nCWV <- apply(do.call(rbind, nCWV), 2, as.list)
nCWV <- lapply(nCWV, function(x){do.call('cbind', x)})
nCWV <- lapply(nCWV, data.frame)
CWV.pval <- data.frame(mapply(function(x,y){
  mapply(function(p,q){
    rank(c(p,q))[1]/(n+1)
  }, p = as.list(x), q = as.list(data.frame(t(y))))
}, x = CWV, y = nCWV))
CWV.pval.res <- data.frame(inf = apply(apply(CWV.pval, 2, p.adjust, method = 'fdr'), 2, function(x){length(which(x < 0.025))/length(x)}), sup = apply(apply(1 - CWV.pval, 2, p.adjust, method = 'fdr'), 2, function(x){length(which(x < 0.025))/length(x)}))
## CWV SES
CWV.ses <- data.frame(mapply(function(x,y){
  mapply(function(p,q){
    (p - mean(q))/sd(q)
  }, p = as.list(x), q = as.list(data.frame(t(y))))
}, x = CWV, y = nCWV))
CWV.ses.lm <- apply(CWV.ses, 2, function(y){lm(y ~., R)})
CWV.ses.lm <- lapply(CWV.ses.lm, function(x){step(x, direction = 'both', trace = 0)})
CWV.ses.res <- lapply(CWV.ses.lm, function(x){summary(x)$coefficients})
CWV.ses.res <- lapply(CWV.ses.res, data.frame)
CWV.ses.res <- lapply(CWV.ses.res, function(x){x$res <- paste(format(x$Estimate, scientific = T, digits = 2, trim = T), apply(x[4], 1, stars, ns = '   ')) ; return(x)})
CWV.ses.res <- data.frame(data.table::rbindlist(lapply(CWV.ses.res, function(x){data.frame(t(x[5]))}), fill = T))
CWV.ses.res <- CWV.ses.res[-1]
var <- c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')
CWV.ses.res[,setdiff(var, names(CWV.ses.res))] <- NA
CWV.ses.res <- CWV.ses.res[var]
CWV.ses.res <- apply(CWV.ses.res, 2, as.character)
row.names(CWV.ses.res) <- names(CWV.ses)
CWV.ses.res[is.na(CWV.ses.res)] <- ''
CWV.ses.res <- data.frame(CWV.ses.res)
CWV.ses.res$`$R^2$` <- round(unlist(lapply(CWV.ses.lm, function(x){summary(x)$r.squared})),3)

# Results
# barplot(t(CWV.pval.res), las = 2, col = c('darkblue', 'firebrick'), ylim = c(0,1), ylab = 'Proportion of non null communities') ; legend('topright', c('Inferior','Superior'), fill = c('darkblue', 'firebrick'))
CWV.ses.res <- cbind(c('CWV', rep(' ', length(CWV.ses.res[,1])-1)), row.names(CWV.ses.res), CWV.ses.res)
names(CWV.ses.res)[1:2] <- c(' ', 'Trait')
rm(CWV.pval, CWV.pval.res, CWV.ses.lm, nCWV)
```

```{r CVNND}
# Observed CVNND
CVNND <- apply(L$abundance, 1, function(l){apply(Q, 2, function(q){cati::CVNND(rep(q, l), na.rm = T)})})

# Simulated CVNNDs 
cl <- makeCluster(cores)
clusterExport(cl, list('nQ', 'L'))
nCVNND <- clusterApply(cl, nQ, function(x){
  apply(L$abundance, 1, function(l){
    apply(x, 2, function(q){
      cati::CVNND(rep(q,l), na.rm = T)
    })
  })
})
stopCluster(cl) ; rm(cl)
rm(nQ) ; invisible(gc)
## Non null CVNNDs
nCVNND <- lapply(nCVNND, function(x){as.list(data.frame(t(x)))})
nCVNND <- lapply(nCVNND, function(x){lapply(x, function(y){names(y) <- colnames(CVNND) ; return(y)})})
nCVNND <- lapply(nCVNND, `[`, names(nCVNND[[1]]))
nCVNND <- apply(do.call(rbind, nCVNND), 2, as.list)
nCVNND <- lapply(nCVNND, function(x){do.call('cbind', x)})
nCVNND <- lapply(nCVNND, data.frame)
CVNND.pval <- data.frame(mapply(function(x,y){
  mapply(function(p,q){
    rank(c(p,q))[1]/(n+1)
  }, p = as.list(x), q = as.list(data.frame(t(y))))
}, x = as.list(data.frame(t(CVNND))), y = nCVNND))
row.names(CVNND.pval) <- colnames(CVNND)
CVNND.pval <- apply(CVNND.pval, 2, p.adjust, method = 'fdr')
CVNND.pval.res <- data.frame(inf = apply(CVNND.pval, 2, function(x){length(which(x < 0.05))/length(x)}))
## CVNND SES
CVNND.ses <- data.frame(mapply(function(x,y){
  mapply(function(p,q){
    (p - mean(q))/sd(q)
  }, p = as.list(x), q = as.list(data.frame(t(y))))
}, x = as.list(data.frame(t(CVNND))), y = nCVNND))
row.names(CVNND.ses) <- colnames(CVNND)
CVNND.ses.lm <- apply(CVNND.ses, 2, function(y){lm(y ~., R)})
CVNND.ses.lm <- lapply(CVNND.ses.lm, function(x){step(x, direction = 'both', trace = 0)})
CVNND.ses.res <- lapply(CVNND.ses.lm, function(x){summary(x)$coefficients})
CVNND.ses.res <- lapply(CVNND.ses.res, data.frame)
CVNND.ses.res <- lapply(CVNND.ses.res, function(x){x$res <- paste(format(x$Estimate, scientific = T, digits = 2, trim = T), apply(x[4], 1, stars, ns = '   ')) ; return(x)})
CVNND.ses.res <- data.frame(data.table::rbindlist(lapply(CVNND.ses.res, function(x){data.frame(t(x[5]))}), fill = T))
CVNND.ses.res <- CVNND.ses.res[-1]
CVNND.ses.res[,setdiff(var, names(CVNND.ses.res))] <- NA
CVNND.ses.res <- CVNND.ses.res[var]
CVNND.ses.res <- apply(CVNND.ses.res, 2, as.character)
row.names(CVNND.ses.res) <- names(CVNND.ses)
CVNND.ses.res[is.na(CVNND.ses.res)] <- ''
CVNND.ses.res <- data.frame(CVNND.ses.res)
CVNND.ses.res$`$R^2$` <- round(unlist(lapply(CVNND.ses.lm, function(x){summary(x)$r.squared})),3)

# Results
# barplot(t(CVNND.pval.res), las = 2, col = c('darkblue'), ylim = c(0,1), ylab = 'Proportion of non null communities') ; legend('topright', c('Inferior'), fill = c('darkblue'))
CVNND.ses.res <- cbind(c('CVNND', rep(' ', length(CVNND.ses.res[,1])-1)), row.names(CVNND.ses.res), CVNND.ses.res)
names(CVNND.ses.res)[1:2] <- c(' ', 'Trait')
kable(bold(rbind(CWV.ses.res,CVNND.ses.res)), row.names = F)
rm(CVNND.pval, CVNND.pval.res, CVNND.ses.res, CVNND.ses.lm, nCVNND) ; invisible(gc())
```

## Floristic, functional and phylogenetic composition between communities

Floristic composition between communities is correlated significantly to environement spatial organization with Mantel test ($r_{I_{st},E} = 0.23$ with $p-value < 0.001$) and without any spatial residuals represented with partial Mantel test knowing environment ($r_{I_{st},S|E} = 0.01$ with $p-value > 0.1$).

Overall, functional composition between communities is not correlated to environment nor to space knowing the environment effect (see table 5). Still WD between communities, in abundance as well as in presence absence, is positively significantly correlated to environment and is even negatively correlated in presence absence to spatial structure knowing environment spatial effect. 

Whereas LDMC is not phylogenetically convergent nor divergent (Moran's I of 0 with a $p-value > 0.1$), LA and Thick are significantly convergent among the phylogenetic tree (Moran's I of 0.021 and 0.018 with a $p-value < 0.001$), and WD and SLA are weakly convergent (Moran's I of 0.005 and 0.003 with $p-value < 0.1$). Phylogenetic composition between communities is not correlated to environement spatial organization with Mantel test ($r_{\beta_{st},E} = 0.02$ and $r_{\pi_{st},E} = 0.05$ with $p-value > 0.1$) nor with spatial residuals represented with partial Mantel test knowing environment ($r_{\beta_{st},S|E} = 0.01$ and $r_{\pi_{st},S|E} = -0.01$ with $p-value > 0.1$).

<!-- **Table to replace by text**: Summary of Mantel test between floristic composition, environment and spatial distances between communities. _$Ist$  was used to investigate variation of floristic composition between communities. Observed values were compared to a null model randomizing individuals among subplots while preserving the regional abundance of species, and the number of individuals per community. E is the mantel test of the metric with the environmental distance matrix issued from PCA two first axes. S|E is the mantel partial test of the spatial distance matrix knowing the environment matrix. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001).._ -->

```{r Ist}
library(spacodiR)

# Environmental matrices
XY <- data.frame(as(quadrats(), 'SpatialPoints')@coords)
row.names(XY) <- paste0('C',row.names(XY))
XY <- XY[row.names(L$abundance),]
Ms <- dist(XY)
XY <- pca.env$scores[,1:2]
row.names(XY) <- paste0('C',row.names(XY))
XY <- XY[row.names(L$abundance),]
Me <- dist(XY)
rm(XY)

# Observed Ist
spaflo <- spacodi.calc(sp.plot = t(L$abundance), pairwise = T)$'pairwise.Ist'
## Mantel values
spaflo.mantel <- list(`E` = vegan::mantel(spaflo, Me, permutations = 0)$statistic, 
                      `S | E`= vegan::mantel.partial(spaflo, Ms, Me, permutations = 0)$statistic)

# Simulated mantel
nL <- vegan::permatfull(L$abundance, fixedmar = 'both', mtype = 'count', times = n, shuffle = 'both')
cl <- makeCluster(cores)
clusterExport(cl, list('nL', 'spacodi.calc', 'Me', 'Ms'))
nspaflo <- lapply(nL$perm, function(l){spacodi.calc(sp.plot = t(l), pairwise = T)$'pairwise.Ist'})
nspaflo.mantel <- lapply(nspaflo, function(ns){
  list(`E` = vegan::mantel(ns, Me, permutations = 0)$statistic, 
       `S | E`= vegan::mantel.partial(ns, Ms, Me, permutations = 0)$statistic)})
stopCluster(cl)
rm(cl, nL) ; invisible(gc())
## Non null mantels
nspaflo.mantel <- lapply(nspaflo.mantel, `[`, names(nspaflo.mantel[[1]]))
nspaflo.mantel <- apply(do.call(rbind, nspaflo.mantel), 2, as.list)
nspaflo.mantel <- lapply(nspaflo.mantel, unlist)
spaflo.res <- mapply(function(s, ns){
    paste(format(s, scientific = T, digits = 3),
          Uppangala::stars(min(1-rank(c(s,ns))[1]/(n+1),rank(c(s,ns))[1]/(n+1)), ns = '   '))
}, s = spaflo.mantel, ns = nspaflo.mantel)
spaflo.res <- data.frame(spaflo.res)
names(spaflo.res) <- c('$I_{st}$')

# Result
# kable(bold(spaflo.res))
rm(mtest, spaflo.mantel, nspaflo, nspaflo.mantel, spaflo.res)
```

Table 5: Summary of Mantel test between functional composition, environment and spatial distances between communities. _$U st$ and $\tau st$ metric proposed by @hardy_characterizing_2007 were used to investigate variation of functional composition between communities. Observed values were compared to the null model NM1 randomizing traits among species (permuting raw in `Trait*Species` matrix). E is the mantel test of the metric with the environmental distance matrix issued from PCA two first axes. S|E is the mantel partial test of the spatial distance matrix knowing the environment matrix. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r Ust & TAUst}
# Observed Hardys
spafun <- lapply(as.list(1:length(Q)), function(i){
  if (length(which(is.na(Q[i]))) > 0) {
    sel <- intersect(names(L$abundance), row.names(Q[-which(is.na(Q[i])),]))
    return(spacodi.calc(sp.plot = t(L$abundance[sel]), sp.traits = data.frame(Q[sel,i], row.names = sel), pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
  } else {
    return(spacodi.calc(sp.plot = t(L$abundance), sp.traits = Q, pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
  }
})
names(spafun) <- names(Q)
## Mantel values
spafun.mantel <- lapply(spafun, function(t){list(`E` = lapply(t, function(M){vegan::mantel(M, Me, permutations = 0)$statistic}), `S | E` = lapply(t, function(M){vegan::mantel.partial(M, Ms, Me, permutations = 0)$statistic}))})


# Simulated mantel
cl <- makeCluster(cores)
clusterExport(cl, list('nQ', 'L', 'Me', 'Ms', 'spacodi.calc'))
nspafun.mantel <- clusterApply(cl, nQ, function(q){
  s <- lapply(as.list(1:length(q)), function(i){
    if (length(which(is.na(q[i]))) > 0) {
      sel <- intersect(names(L$abundance), row.names(q[-which(is.na(q[i])),]))
      return(spacodi.calc(sp.plot = t(L$abundance[sel]), sp.traits = data.frame(q[sel,i], row.names = sel), pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
    } else {
      return(spacodi.calc(sp.plot = t(L$abundance), sp.traits = q, pairwise = T)[c('pairwise.Ust', 'pairwise.TAUst')])
    }
  })
  names(s) <- names(q)
  res <- list(
    `E` = lapply(s, function(t){
      lapply(t, function(M){
        try(vegan::mantel(M, Me, permutations = 0)$statistic)
        })
      }),
    `S | E` = lapply(s, function(t){
      lapply(t, function(M){
        try(vegan::mantel.partial(M, Ms, Me, permutations = 0)$statistic)
        })
      })
    )
  res <- lapply(res, function(r){names(r) <- names(q) ; return(r)})
  res <- lapply(res, `[`, names(res[[1]]))
  res <- apply(do.call(rbind, res), 2, as.list)
  return(res)
})
stopCluster(cl)
rm(cl, nQ) ; invisible(gc())

## Non null mantels
nspafun.mantel <- lapply(nspafun.mantel, `[`, names(nspafun.mantel[[1]]))
nspafun.mantel <- apply(do.call(rbind, nspafun.mantel), 2, as.list)
nspafun.mantel <- lapply(nspafun.mantel, function(s){lapply(s, `[`, names(s[[1]]))})
nspafun.mantel <- lapply(nspafun.mantel, function(s){apply(do.call(rbind, s), 2, as.list)})
nspafun.mantel <- lapply(nspafun.mantel, function(s){lapply(s, function(m){lapply(m, `[`, names(m[[1]]))})})
nspafun.mantel <- lapply(nspafun.mantel, function(s){lapply(s, function(m){apply(do.call(rbind, m), 2, as.list)})})
nspafun.mantel <- lapply(nspafun.mantel, function(s){lapply(s, function(x){lapply(x, function(x){as.numeric(unlist(x))})})})
spafun.res <- data.frame(mapply(function(x,y){
  mapply(function(r,s){
    mapply(function(p,q){
      paste(round(p, 3), Uppangala::stars(min(rank(c(p,q))[1]/(n+1), 1-rank(c(p,q))[1]/(n+1)), ns = '   '))
    }, p = r, q = s, SIMPLIFY = F)
  }, r = x, s= y)
}, x = spafun.mantel, y = nspafun.mantel))
spafun.res <- cbind(data.frame('Mantel statistic' = c('E', ' ', 'S|E', ' '), 'Metric' = rep(c('$U_{st}$', '$\\tau _{st}$'), 2)), spafun.res)

# Result
kable(bold(spafun.res))
rm(spafun.mantel, nspafun.mantel, spafun.res)
```

```{r PhyloMaker, include=FALSE}
library(phylosignal)
library(phytools)
library(phylobase)
path <- system.file('phylogeny', package = 'Uppangala')
source(file.path(path, 'R_codes for function S.PhyloMaker.txt'))
phylo <- read.tree(file.path(path, 'PhytoPhylo.tre'))
nodes <- read.csv(file.path(path, 'nodes.csv'), h = T)
sp <- Species[which(Species$LatinName %in% row.names(PFT_sp)), c('LatinName', 'Genus', 'Family')]
names(sp) <- c('species', 'genus', 'family')
results <- invisible(S.PhyloMaker(sp, phylo, nodes)) # Humboldtia_brunonis unmatched
tree <- results$Scenario.1
rm(phylo, results, modes, sp, S.PhyloMaker, path)
```

<!-- **Table to replace by text**: Summary of Moranâ€™s I statistic and p-values for phylogenetic signal of functional traits. _See table 1 for abbreviations. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._ -->

```{r Phylosignal}
data <- PFT_sp
row.names(data) <- gsub(' ', '_', row.names(data), fixed = T)
tips <- row.names(data)[which(is.na(data$WD))]
phy <- drop.tip(tree, tips)
data <- data[phy$tip.label,c(2:5,7)]
p4d <- phylo4d(phy,data)
phyloS <- phyloSignal(p4d, methods = 'I') 
phyloS <- data.frame(paste(round(phyloS$stat[,1], 3), 
                           unlist(lapply(as.list(phyloS$pvalue[,1]), stars, ns = ' '))),
                     row.names = row.names(phyloS$stat))
names(phyloS) <- 'Moran\'s I'
# kable(bold(phyloS))
rm(data, tips, p4d, phyloS, phy)
```

<!-- **Table to replace by text**: Summary of Mantel test between phylogenetic composition, environment and spatial distances between communities. _$\beta st$ and $\pi st$ metric proposed by @hardy_characterizing_2007 were used to investigate variation of phylogenetic composition between communities. Observed values were compared to the one obtained with the null model *"1s"*" suggested by @hardy_testing_2008 randomizong phylogenetic tree tips. E is the mantel test of the metric with the environmental distance matrix issued from PCA two first axes. S|E is the mantel partial test of the spatial distance matrix knowing the environment matrix. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._ -->

```{r BETAst $ PIst}
# Observed Hardys
phy <- tree
phy$tip.label <- Species$SpCode[match(gsub('_', ' ',phy$tip.label), Species$LatinName)]
tips <- c(setdiff(phy$tip.label, names(L$abundance)), setdiff(names(L$abundance), phy$tip.label))
phy <- drop.tip(phy, tips)
phy$node.label <- NULL
spaphy <- spacodi.calc(sp.plot = t(L$abundance), phy = phy, pairwise = T)[c('pairwise.Bst', 'pairwise.PIst')]
## Mantel values
spaphy.mantel <- list(`E` = lapply(spaphy, function(m){vegan::mantel(m, Me, permutations = 0)$statistic}), 
                      `S | E`= lapply(spaphy, function(m){vegan::mantel.partial(m, Ms, Me, permutations = 0)$statistic}))

# Simulated mantel
nphy <- rep(list(phy), 999)
cl <- makeCluster(cores)
clusterExport(cl, list('nphy', 'L', 'spacodi.calc', 'Ntip', 'resamp.phy', 'branching.times'))
nphy <- clusterApply(cl, nphy, resamp.phy)
stopCluster(cl)
nspaphy <- lapply(nphy, function(p){spacodi.calc(sp.plot = t(L$abundance), phy = p, pairwise = T)[c('pairwise.Bst', 'pairwise.PIst')]})
rm(cl, nphy) ; invisible(gc())
nspaphy.mantel <- list(`E` =lapply(nspaphy, function(x){lapply(x, function(M){vegan::mantel(M, Me, permutations = 0)$statistic})}), `S | E` = lapply(nspaphy, function(x){lapply(x, function(M){vegan::mantel.partial(M, Ms, Me, permutations = 0)$statistic})}))
## Non null mantels
nspaphy.mantel <- lapply(nspaphy.mantel, function(s){lapply(s, `[`, names(s[[1]]))})
nspaphy.mantel <- lapply(nspaphy.mantel, function(s){apply(do.call(rbind, s), 2, as.list)})
nspaphy.mantel <- lapply(nspaphy.mantel, function(s){lapply(s, unlist)})
spaphy.res <- mapply(function(s, ns){
  mapply(function(x,y){
    paste(format(x, scientific = T, digits = 3), 
          Uppangala::stars(min(1-rank(c(x,y))[1]/(n+1),rank(c(x,y))[1]/(n+1)), ns = '   '))
  }, x = s, y = ns)
}, s = spaphy.mantel, ns = nspaphy.mantel)
row.names(spaphy.res) <- c('$\\beta_{st}$', '$\\pi_{st}$')
  
# Result
# kable(bold(spaphy.res))
rm(mtest, spaphy.mantel, nspaphy, nspaphy.mantel, spaphy.res)
```

# Discussion

## Ecological strategies

Plants distinguish theimselves in functional trait composition betwen individuals and even more between species. Variation of species functional composition results from functional trade-offs that compose major variation axes of functional traits called economic spectra. We found back the leaf economic spectrum of @wright_worldwide_2004 opposing in our case SLA to LDMC in a trade-off between productivity, with less carbon investment for higher photosynthesis rates, opposed to persistance, with more leaf defense and investment. Independantly to that spectrum, we detected a second major axis of trait variation opposing WD to LA and Thick. This axis opposes more resistant to stress and disturbance species, thanks to denser wood, to competitive species, with thicker and larger leaves for a more efficient water conductivity. This spectrum correspond to the wood economic spectrum described by @chave_towards_2009, and more precisely this opposition between small thin leave with dense wood to large thick leaves with light wood correspond to the additional gradient uncovered by  @baraloto_decoupled_2010.

Results are similar to the one found by @fortunel_leaf_2012 where PCA first and second axes were respectively interpreted as leaf and wood economic spectrum (inverted compare to us). Our results integrate less traits (5 against 14), and less species (89 against 758), at a smaller scale, but still capture the same strategy axes.

## Local functional composition

The leaf economic spectrum is majorly affected by aspect with a convergence of value toward optimal functional traits under south-west orientation, especially for LDMC of rare species. Aspect, and more specifically south-west, effect in tropical forest is scarcely documented but highlighted in discussion by @gunatilleke_specieshabitat_2006. @bunyan_effect_2015 observed a similar effect on shola distribution of Western Ghats and suggested it could result from monsoon winds. Effectively monsoon winds arise fom south-west direction in this region, and bring more stressfull and disturbed conditions to species [@soman_aspects_1990]. Curvature is also affecting the leaf economy. Convex area will accumulate soil and attract water flux increasing soil fertiliy conditions for species that will invest more in leaf ressource acquisition toward a productive strategy with higher SLA and a convergent optimal LDMC. SLA and LDMC with curvature effect seems to reflect well soil fertility [@hodgson_is_2011]. 

Biotic factors also affect the LES through the negative effect of canopy height on LDMC. The canopy height effect is null on understorey species and only apply on species that take part in the canopy composition or emerge (results unshown). We would assumed that understorey species would be investing in higher LDMC for an higher leaf lifespan under shade stress [@kitajima_tissue-level_2010]. But both the high variation of canopy height resulting in a relatively light open canopy and the dry season of 3.8 months suggest that leaf lifespan investment is not so obvious. Instead of a growth-survival trade-off shade tolerant species may adopt a more low-high light growth trade-off strategy [@poorter_leaf_2009] strongly affecting SLA but not driving LDMC. Emergent and high canopy species will have a lower LDMC, resulting from a more productive strategy toward leaf resource acquisition at the expense of leaf carbon investment in defense and resistance. Thus canopy species with the lowest LDMC will grow the fastest and then reach the highest canopy. Measurement of LDMC on species classified as canopy and emergent are realized most of the time on shadow leaves from understorey individuals. Still we observed previous relation indicating that species phylogenetic determinism is stronger than micro-environmental variation plasticity for LDMC, as suggested by the intra-specific variation of LDMC 1.5 times bigger than intra-individuals variation.

The wood economic spectrum defined by WD, LA, and Thick is only partially affected by environment at our 10 ha plot scale. Neutral hypothesis of funcional equivalence [@hubbell_neutral_2005] are most of the times sufficient to build back similar links between topography and functional compoisiton of communities. Still aspect wiht south-west orientation and curvature are the two main ecological factors filtering functional traits from the wood economic spectrum. South-west orientation, with probably more disturbance and stress from monsoon, result in denser wood with reduced eveness by convergence toward different optimal density. In parrallel, south-west direction broaden leaf size strategies, pehraps to answer to hydraulic diversity induced by WD multimodality, as WD and LA are mechanically linked [@coomes_scaling_2008]. Fertility decrease, with concavity, results in smaller leaves inside communities with a distribution broaden by multimodality reducing eveness. Wetness is increasing with higher curvature and lower LA eveness, indicating that multimodality is happening more in wettest low elevation area. Wetness could compensate water departure trigerred by positive curvature in lower elevation areas. 

## Composition between communities

Limited dispersal, assumed by neutral theory [@condit_beta-diversity_2002], does not affect florisitic composition of communities at the 10 ha plot scale revealed by the absence of links  with spatial residuals. Florisitic composition of communities is only shaped by environment. On opposite, functional composition is overall not structured with environment nor with spatial residuals. At the 10 ha level functional variation between communities is stochastic; whereas at the community level environment is partially shapping florisitic composition. Measured functional traits should vary to a larger scale [@messier_trait_2016]. Still environment is shaping community resistance to disturbance and stress by affecting wood density $\beta$ structure at fine scale. WD of rare species is even diverging with spatial residuals supposing an unaccounted spatially organized variable opposing close community in WD composition. Topography removed from spatial residuals, and climate and pedology being constant in the 10 ha plot, this unaccouted variation is assumed to be due to stochastic event in plot history as death. Unshowed analysis reveals that this spatial divergence of WD is not explained by tree death events from the two last decades but certainly to older events. Finally, variation in distance between taxon wasn't translated in phylogenetic variation whereas most of measured functional traits appeared phylogenetically conserved and clustered.

## Limits and perspectives

Ecological strategies underline two econmic spectra as shown by @baraloto_decoupled_2010. Whereas the multivariate analysis of our functional traits lack trait diversity for correct interpretations of functional trade-offs. Measured traits were all morphological and from the leaf except for one. Anatomical and chemical traits as leaf vein patterns and leaf chemical content (N, P, K) could brought broader perspective on ecological strategies of Western Ghats species. Still the study reveal that few commonly used traits can highlight well known strategy axes.

Besides patterns have been detected between functional composition and environment at both local ($\alpha$) and between-community ($\beta$) scales. Lot of relation observed didn't differ from those obtain with null hypothesis reflecting neutral theory [as functional equivalence, @hubbell_neutral_2005]. Ecological gradient and spatial scale sizes can be at the origin of this lack of environmental filtering. Effectively the abiotic variation is mainly topographic with a constant climate and pedology. Study highlighting environmental filtering often present a higher environmental variation [@bernard-verdier_community_2012]. In parallel, the 10 ha plot scale is really low and partially responsible for the small environmental variation. @kraft_functional_2008 detected topographical filtering on functional trait and @gunatilleke_specieshabitat_2006 observed niche differentiation on 25 ha tropical forest plots including large flat valleys. This mid-low elevation study of functional traits from Western Ghats forest could be reproduced at higher elevation or in dryer areas as Eastern Ghats for better insight of environmental filtering at broad scale. On the other hand, WD as shown to be filtered by environment at fine scale both in $\alpha$ and $\beta$ levels. Species wood seems highly adpted to environment in Western Gahts forests in link to monsoon events.

# *Acknowledgement*

French Institute of Pondicherry (FIP)

# Supplementary materials

## S1: Principal component analysis performed on topgraphical variables

```{r PCA Env}
lambda <- pca.env$sdev * sqrt(nrow(pca.env$scores))
pca.env.var = apply(pca.env$score, 2, var)
plot(t(t(pca.env$scores)/lambda),pch=16, col = 'lightgrey',
     xlab = paste('Axe 1 -', round(pca.env.var[1]/sum(pca.env.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.env.var[2]/sum(pca.env.var)*100, 2), '%'))
Hmisc::subplot(function(){
  b <- barplot((pca.env.var / sum(pca.env.var)), las = 2,
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.env.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.07,0.37), from='npc'),
  y=grconvertY(c(0.025,0.30), from='npc')
)
par(new=T)
Rot <- t(t(pca.env$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, lwd = 2)
lines(c(0,0), XLIM, lty = 2, lwd = 2)
col <- c("#1874CD", "#008B00", "#CD3700", "#9400D3")[c(2, 3, 1, 1, 1,  2, 1, 4)]
arrows (rep(0,nrow(pca.env$loadings)),rep(0,nrow(pca.env$loadings)),
        Rot[,1],Rot[,2],lwd=2,col=col)
legend('topright', c('Elevation', 'Slope', 'Water flow', 'South-West'),
       text.col = col, cex = 1.2)
text (Rot[,1:2], pos = c(2, 2, 2, 1, 1, 3, 3, 4), rownames(Rot),cex=1.2,col=col)
axis (3)
axis (4)
```

Supplementary material S1: Principal component analysis (PCA) performed on topgraphical variables. *Botom left corner subplot represents the eigen values (grey bars) compare to a broken stick distribution for 7 components (red line). SW stand for southwesterness.*

Curvature covary with profile curvature, plan curvature, distance to potential rivers and the PCA first axis. Elevation and wetness are opposed in the principal component analysis and slope and south-westerness doesn't seem to covary much with other variables.

# References
