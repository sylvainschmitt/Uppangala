---
title: 'Uppangala tree functional traits: Article draft'
author: Sylvain Schmitt sylvain.schmitt@agroparistech.fr
output: pdf_document
bibliography: refs.bib
---

```{r config, message=FALSE, warning=FALSE, include=FALSE}
library(knitr)
library(parallel)
library(Uppangala)
opts_chunk$set(
  echo = F, message = F, warning = F, fig.height = 8, fig.width = 8,
  cache = T, cache.lazy = F)
```

# Abstract

Keywords: functional trait, tropical evergreen forest, Western Ghats, India...

# Introduction

**Study scheme:**

1. Do variations and covariations in functionnal traits can reveal species ecological strategies ?
    i. Do functionnal traits vary among species ?
    ii. Do covariations in functional traits represent axes of ecological strategy ?
2. Do functional composition reflect the influence of abiotic and biotic drivers of community dynamics ?
    i. Do local functional composition reflect the influence of abiotic and biotic drivers of community dynamics ?
    ii. Do functional composition variation between communities reflect the influence of abiotic and biotic drivers of community dynamics ?

**To add:**

* Functional traits can be linked to trade-offs in tree strategy for functionning, survival and reproduction [@baraloto_decoupled_2010, and see table 1], which vary depending on environment condition. For instance, SLA varies along a soil fertility - shade index whereas LDMC will only be linked to soil fertility [@hodgson_is_2011].
* Leaf investment definition
* Leaf ressource acquisition definition

# Material and methods

## Study site

The study was carried out in the Kadamakal Reserve Forest (Kodagu District, Karnataka State, India), in the 10-ha "Uppangala plot" named after the nearest village. The permanent plot was established in 1990 by the French Institute of Pondicherry and described by @pascal_structure_1996. The Uppangala plot vegetation was assigned to low elevation *Dipterocarpus indicus - Kingiodendron pinnatum - Humboldtia brunonis* dense moist evergreen forest type [@pascal_wet_1988]. Climate and geology of the 10-ha plot can be considered as homogeneous. General topagraphy of the site shows a regular east-west alternation between thalwegs and ridges separated by relatively steep slopes, so that topography can be assumed as the major local abiotic factor which varies inside the plot [@gimaret-carpentier_sampling_1998]. Each tree girth is monitored by a two-year census.
**Girth monitoring to develop shortly**

## Wood and leaf sampling

We collected trait data on 91 over 117 (78%) species. We sampled five individuals per species for most abundant species and we completed with less abundant and rare species with one to five individuals. Most abundant species were defined as the 32 species respresenting more than 80% of Uppangala tree individuals. Thus we generated data for 98.8% of the tree individuals present in the Uppangala plot. For each individual we collected 6 mature shadow dry leaves and one branch sample with a diameter close to 1cm following recommendation from @perez-harguindeguy_new_2013. Individuals and leaves were selected regarding their light condition, development stage and sanitary state for consistancy. Dawkins crown exposure index [@dawkins_management_1958] was registered to check the validity of the sampling. Leaf and branch samples were kept in humidified ziplock filled with enriched CO2 air inside a black bag untill their measurement in the following 24 hours. For some individuals we were unable to collect an appropriate branch sample (58 over 267 individuals representing 12 missing species over 91).

## Trait measurements

Leaf petioles, rachis and petiolules were removed for all measurements. Leaf fresh weights, area and thickness were measured, using a scanner [cite] and a microgauge [cite]. Leaves were first kept in herbarium and then dried in an oven for at least 72 hours at 60 degrees celsisus, the drying process was stopped after dry leaf weights were stable in time. Once dried, the leaves were weighted directly after been extracted from the oven to avoid humidity bias. The bark and pit of branch samples were removed in order to keep only branch wood with no soft tissues. Branch wood samples were sink in water to evaluate their volume by water displacement. Samples were then dried for 48 hours at 80 degrees celsius and weighted. 

We calculated five functional traits of leaf and wood samples: leaf thickness (Thick in $\mu m$ ), leaf area measured from scans (LA in $mm^2$), leaf dry matter content as the leaf dry weight divided by the leaf fresh weight (LDMC in $mg.g^-1$), specific leaf area as the leaf area divided by the leaf dry mass (SLA in $m^2.kg^-1$), and branch wood density  as the the wood sample dry weight divided by its volume (WD in $g.cm^-3$, see table 1). 

Table 1: Functional traits measured. *Traits with their abbreviation, range of values in the sampling, mean and standard deviation, standard unit, and associated trade-off in tree strategy for functionning, survival and reproduction from @baraloto_decoupled_2010.*

```{r 1 Traits}
rm(list = ls()); invisible(gc())
PFT <- genPFT()
table <- data.frame(
  traits = c('Thickness', 'Leaf area', 'Leaf dry matter content', 'Specific leaf area', 'Wood density'),
  abbreviation = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'),
  range = c(paste(range(PFT$Thick, na.rm = T), collapse = '-'),
            paste(round(range(PFT$LA, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$LDMC, na.rm = T)), collapse = '-'),
            paste(round(range(PFT$SLA, na.rm = T), 2), collapse = '-'),
            paste(round(range(PFT$WD, na.rm = T), 2), collapse = '-')),
  `mean (sd)` = c(paste0(round(mean(PFT$Thick, na.rm = T)), ' (',
                         round(sd(PFT$Thick, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LA, na.rm = T)), ' (',
                         round(sd(PFT$LA, na.rm = T)), ')'),
                  paste0(round(mean(PFT$LDMC, na.rm = T)), ' (',
                         round(sd(PFT$LDMC, na.rm = T)), ')'),
                  paste0(round(mean(PFT$SLA, na.rm = T),2), ' (',
                         round(sd(PFT$SLA, na.rm = T),2), ')'),
                  paste0(round(mean(PFT$WD, na.rm = T),2), ' (',
                         round(sd(PFT$WD, na.rm = T),2), ')')),
  unit = c('um', 'mm2', 'mg.g-1', 'm2.kg-1', 'g.cm-3'),
  strategy = c('Leaf defense vs. investment',
               'Leaf ressource capture vs.investment',
               'Leaf defense vs. investment',
               'Leaf ressource acquisiton vs. defense',
               'Stem transport, structure and defense')
  )
kable(table,  label="traits", row.names = F)
rm(table)
```

## Environmental variables

We selected 8 topographical variables representing abiotic factors: digital elevation model, slope, curvature, plan curvature, profile curvature, wetness (function of both slope and elevation representing water flow and accumulation areas), southwesterness (SW, aspect in direction of south-west), and distance to the nearest potential river. Digital elevation model is issued from a 2013 LIDAR campaign on Uppangala plots with a resolution of $1*1 m^2$. Slope, curvature, plan curvature, profile curvature, wetness and southwesterness ($cos(aspect~in~degres + 225)$) are all derived from the digital elevation model with the RSAGA package [@brenning_statistical_2008]. Distance to the nearest potential river was computed using ArcGis [@desktop_arcgis_2011].

In order to avoid multi-colinearity in future analyses, we reduced our abiotic factors explanatory variables via a principal component analysis (PCA), by keeping less correlated variables with the most ecological meaning. We reduced our explanatory variables to 4: curvature to represent the water flow paths and soil stabilization areas, wetness to highlight water accumulation areas, southwesterness to represent monsoon winds [@bunyan_effect_2015] and slope.

We selected two uncorrelated biotic factors: canopy height and basal area (Spearman's $rho = -0.09$, $p-value > 0.1$). Canopy height was calculated from a digital canopy model built with the 2013 LIDAR campaign on Uppangala plots with resolution $1*1 m^2$. Basal area was calculated from 2013 girth inventory of Uppangala plot on stems with a diameter above 10 centimeters at breast height ($DBH>10~cm$). 

## Analyses

### Traits variation and covariation

Traits variation was first investigated in three levels with the coefficient of variation ($cv = \frac{\sigma}{\mu}$ with $\sigma$ the standard deviation and $\mu$ the mean) between leaves of the same individual (intra-individual), between trees of the same species (intra-specific), and between species (inter-specific).

For the rest of the statistical analysis, we calculated the mean value of each 5 traits for our 92 species. To test the correlation and covariation among traits we performed a principal component analysis (PCA).

### Functional composition of communities

Among the whole 10 hectares plot from Uppangala, 240 spatial communities where defined with $20*20 m^2$ quadrats. To test for pattern in functional composition of communities we used null model approach. A first null model (NM1) randomizes traits among species (permuting raw in `Trait*Species` matrix). The second model (NM2) randomizes abundances among species inside each community but keeps the observed list of species and trait values inside communities. NM1 allow to assess environmental filtering and biotic process on Uppangala plot species. NM2 bring more insight on environmental and biotic effects on species distribution inside communities [@bernard-verdier_community_2012].

To investigate traits distribution of communities we used community weighted means (CWM), community weighted variances (CWV), and coefficients of variation from the nearest neighbour distance (CVNND) [CWM and CWV, sensu @violle_let_2007, CVNND, @jung_intraspecific_2010]. CWV lower than expected under a null model will be evidence for convergence of traits inside the community whereas higher CWV will show divergence in trait distribution. CVNND is used to detect niche differenciation patterns in case of a lower CVNND as observed under a null model.

CWM for each trait $t$ was calculated as the mean of species trait values, $t_{i}$, of the $S$ species in each community, with each species, $i$, weighted by its relative
abundance, $p_{i}$:
$$CWM = \sum_{i=1}^{S} p_{i} * t_{i} ~ (1)$$
CWM was also computed in presence-absence, to get better insight of the role of rare species in community traits distribution. CWV for each trait $t$ was calculated as the difference between the mean of species trait values, $t_{i}$, and the $CWM$, of the $S$ species in each community, with each species, $i$, weighted by its relative
abundance, $p_{i}$:
$$CWV = \sum_{i=1}^{S} p_{i} * (t_{i} - CWM)^2 ~ (2)$$
CVNND was computed in abundance inside each community. For both CWV and CVNND, we calculated the standardized effect size (SES) as: 
$$SES = \frac{(I_{obs} - I_{null})}{\sigma _{null}}$$
where $I_{obs}$ is the observed metric and $I_{null}$ and $\sigma _{null}$ are the mean and standard deviation of null distributions of NM2 and NM1 for CWV and CVNND respectively.

Linear regressions between CWMs and biotic and abiotic factors after step measure were compared to corresponding 999 null linear regressions from NM1 with F-statistic. For both CWV and CVNND, proportion of of communities differing from null expectaions was tested with a two-tailed test; and links between SES and environment was investigated by linear regression. Analyses were conducted on the five functional traits and the two economic spectra defined with the species scores obtained on the 2 first PCA axes.

### Composition variation between communities

Phylogenetic tree of our 92 species was built with `S.PhyloMaker` function implemented by @qian_updated_2016-1. Phylogenetic signal was globaly assessed for each functional trait among the phylogenetic tree by Moran's I statistic. Positive Moran's I value will indicate convergence of trait value inside the phylogeny whereas negative Moran's I will show divergence.

$\beta st$ and $\pi st$ metric proposed by @hardy_characterizing_2007 were used to investigate variation of phylogenetic composition between communities. Observed values were compared to the one obtained with the null model *"1s"*" suggested by @hardy_testing_2008 to see if we were under phylogenetic clustering or overdispersion. In parrallel variation of functional composition between communities was assessed by $U st$ and $\tau st$ metric proposed by @hardy_characterizing_2007. Observed values were compared to NM1. Negative Hardy's metrics significate that species are functionaly or phylogenetically

All analysis were conducted in the R 3.3.0  free software environment for statistical analyses and graphics [@r_core_team_r:_2016] using the package 
`ade4` [@dray_ade4_2007], 
`ape` [@paradis_ape:_2004], 
`phylosignal` [@keck_phylosignal:_2015] 
and `spacodiR` [@eastman_spacodir:_2013].

# Results

## Traits variation and covariation

Trait coefficients of variation analysis reveals a general increase of functional trait variation among scales (from intra-individual to inter-specific, see table 2). Whereas LA shows already high variablilty at intra-individual level almost as strong as the intra-specific variation ($CV_{individual} = 0.20$ and $CV_{species} = 0.24$, wilcoxon rank test $p-value = 0.137$). 

Table 2: Coefficient of intra-individual, intra-specific and inter-specific trait variation. *Mean of coefficient of variation for leaves in all individual (intra-individual), for trees in all species (intra-specific), and coefficient of variation for trees for all species. See table 1 for abbreviation.*

```{r 2 CV}
PFT_ind <- aggregate(PFT, by = list(PFT$Tree), FUN = mean, na.rm = T)
row.names(PFT_ind) <- PFT_ind$Group.1
SpT <- unique(PFT[1:2])
Sp <- SpT$Sp
names(Sp) <- SpT$Tree
SpCodeT <- unique(PFT[2:3])
SpCode <- SpCodeT$SpCode
names(SpCode) <- SpCodeT$Sp
CET <- unique(PFT[c(1,4)])
CE <- CET$CE
names(CE) <- CET$Tree
PFT_ind$Sp <- Sp[row.names(PFT_ind)]
PFT_ind$SpCode <- SpCode[as.character(PFT_ind$Sp)]
PFT_ind$CE <- CE[row.names(PFT_ind)]
PFT_ind <- PFT_ind[-c(1:2)]
cv <- data.frame(row.names = c('Thick', 'LA', 'LDMC', 'SLA', 'WD'))
cv$Individual <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT[which(names(PFT) ==  y)], by = list(PFT$Tree), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Species <- unlist(lapply(
  as.list(row.names(cv)),
  function(y){mean(aggregate(PFT_ind[which(names(PFT_ind) ==  y)], by = list(PFT_ind$Sp), function(x){sd(x, na.rm = T) / mean(x, na.rm = T)})[,2], na.rm = T)}))
cv$Community <- unlist(
  lapply(as.list(row.names(cv)),
         function(y){sd(PFT[,which(names(PFT) ==  y)], na.rm = T) /
             mean(PFT[,which(names(PFT) ==  y)], na.rm = T)}))
cv <- round(cv, 2)
cv['WD','Individual'] <- ''
kable(cv)
rm(PFT, CET, cv, CE, Sp, SpT)
```

The multivariate analysis of trait correlation shows WD associated with structural leaf traits orthogonal to the SLA (see figure 1). The first PCA axis (PCA1) covary mainly with Thick, LDMC and WD; opposing thin and big leaves to dense leaves and wood. Whereas the second PCA axis (PCA2) covary mainly with SLA representative of the leaf economic spectrum [LES, @wright_worldwide_2004]. PCA first axis might be associated with the WD covariation to the wood economic spectrum [WES, @chave_towards_2009]. Results are similar to the one found by @fortunel_leaf_2012 where PCA1 and PCA2 were respectively interpreted as leaf and wood economic spectrum (inverted compare to us). Our results integrate less traits (5 against 14), and less species (92 against 758), but still capture the same strategy axes.

```{r 3 PCA PFT}
library(vegan)

PFT_ind$LA <- log(PFT_ind$LA)
PFT_ind$SLA <- log(PFT_ind$SLA)
PFT_ind$ID <- row.names(PFT_ind)
row.names(PFT_ind) <- PFT_ind$ID
PFT_ind <- PFT_ind[-which(names(PFT_ind) == 'ID')]
Species <- genSpecies()
PFT_sp <- aggregate(PFT_ind, by = list(PFT_ind$Sp), FUN = mean, na.rm = T)
row.names(PFT_sp) <- PFT_sp$Group.1
PFT_sp$SpCode <- SpCode[row.names(PFT_sp)]
PFT_sp <- PFT_sp[-c(1:2,4)]
pca <- princomp(~ LA + WD + Thick + LDMC + SLA, data = PFT_sp, cor = T)

lambda <- pca$sdev * sqrt(nrow(pca$scores))
pca.var = apply(pca$score, 2, var)
PCAscores <- as.data.frame(pca$scores)[1:2]
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
plot(t(t(pca$scores)/lambda),pch=16, col = 'lightgrey',
      xlab = paste('Axe 1 -', round(pca.var[1]/sum(pca.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.var[2]/sum(pca.var)*100, 2), '%'))
par(new=T)
Rot <- t(t(pca$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, col = 'firebrick', lwd = 2)
lines(c(0,0), XLIM, lty = 2, col = 'green', lwd = 2)
legend('topright', c('Leaf economic spectrum', 'Wood economic spectrum'),
       text.col = c("green", "firebrick"))

arrows (rep(0,nrow(pca$loadings)),rep(0,nrow(pca$loadings)),Rot[,1],Rot[,2],lwd=2)
text (Rot[,1:2], pos = c(4, 2, 4, 2, 3), rownames(Rot),cex=1.2)
Hmisc::subplot(function(){
  b <- barplot((pca.var / sum(pca.var)), las = 2, ylim = c(0,range(bstick(7))[2]),
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.75,1), from='npc'),
  y=grconvertY(c(0.05,0.30), from='npc')
)
axis (3)
axis (4)

PCAscores <- as.data.frame(pca$scores)[1:2]
names(PCAscores) <- c('WES', 'LES')
PCAscores$ID <- row.names(PCAscores)
PFT_sp$ID <- row.names(PFT_sp)
PFT_sp <- merge(PFT_sp, PCAscores, all = T)
row.names(PFT_sp) <- PFT_sp$ID
PFT_sp <- PFT_sp[-which(names(PFT_sp) == 'ID')]
Q <- PFT_sp[c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'Thick')]
row.names(Q) <- PFT_sp$SpCode
rm(PCAscores, PFT_ind, SpCodeT, lambda, pca, pca.var, Rot, XLIM)
```

Figure 1: Principal component analysis (PCA) performed on species trait means. *Bottom right corner subplot represents the eigen values (grey bars) compare to a broken stick distribution for 6 components (red line). See table 1 for abbreviation.*

```{r 4 env-com}
library(raster)
Env <- genEnv()
Trees <- genTrees()
Trees$ID <- row.names(Trees)
Trees <- merge(Trees, PFT_sp)
row.names(Trees) <- Trees$ID
Trees <- Trees[-which(names(Trees) == 'ID')]
com <- quadrats()
XY <- Trees[c('x', 'y')]
coordinates(XY) <- ~ x + y
proj4string(XY) <- crs(com)
Trees$com <- (XY %over% com)[,1]
com@data$Elevation <- extract(Env$DEM, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
Deriv <- DEMderiv(raster(com, 'Elevation'), c('slope', 'curvature', 'plancurvature', 'profcurvature', 'cosaspect'))
names(Deriv)[5] <- 'SW'
com@data <- cbind(com@data, extract(Deriv, as(com, "SpatialPolygons"), df = T, fun = mean)[-1])
com@data$Wetness <- extract(DEMderiv(Env$DEM, 'wetness'), as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
com@data$Canopy <- extract(Env$Canopy, as(com, "SpatialPolygons"), df = T, fun = mean)[,2]
BA <- aggregate(Trees$Girth, list(Trees$com), function(x){sum(pi*(x/(2*pi))^2, na.rm = T)})
com@data$BA <- BA$x[match(com@data$id, BA$Group.1)]
pca.env <- princomp(~ Elevation + Slope + Curvature + PlanCurvature + ProfileCurvature + Wetness + SW, data = com@data, cor = T)
R <- com@data[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')]
row.names(R) <- com@data$id
L <- data.frame(tapply(rep(1, length(Trees[,1])), list(Trees$com, Trees$SpCode), sum))
L[is.na(L)] <- 0
sel <- intersect(row.names(Q), names(L))
Q <- Q[sel,]
L <- L[sel]
R <- R[row.names(L),]
L <- list(abundance = L, `presence-absence` = L)
L$`presence-absence`[L$`presence-absence` > 1]  <- 1
rm(Deriv, XY, com, Env, Trees, sel, BA)
```

## Functional composition of communities

Table 4: Summary of linear models and null models for traits community weighted means. _Linear model results for each trait community weighted means by species relative abundance after a variable selection by step mesure in both direction with slope, curvature, wetness, and southwesterness (SW), canopy height (Canopy) and basal area (BA). Model global and partial F-statistics were compared to 999 null model F-statistics in which traits were randomized among species. See table 1 for abbreviations. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

**Second table are the result in presence-absence. They are juste here for discussion. But they probably won't be in the final report under this shape.**

```{r CWM}
# Observed CWMs
CWM <- lapply(L, function(l){lapply(as.list(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'Thick')), function(v){apply(l, 1, function(x){weighted.mean(Q[,v], x, na.rm=T)})})})
CWM <- lapply(CWM, function(x){names(x) <- c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'Thick') ; return(x)})
## Regressions
reg <- paste('~', paste(names(R), collapse = ' + '))
CWM.lm <- lapply(CWM, function(x){lapply(x, function(y){lm(y ~., R)})})
CWM.lm <- lapply(CWM.lm, function(y){lapply(y, function(x){step(x, direction = 'both', trace = 0)})})
## Global F
Fval <- lapply(CWM.lm, function(y){lapply(y, function(x){summary(x)$fstatistic['value']})})
Fval <- lapply(Fval, function(x){do.call('rbind.data.frame', x)})
Fval <- data.frame(Fval)
names(Fval) <- names(CWM.lm)
## Partial F
pFval <- lapply(CWM.lm, function(y){lapply(y, function(x){car::Anova(x)['F value']})})

# Simulated CWMs
n = 999
nQ <- rep(list(Q), n)
nQ <- lapply(nQ, function(x){row.names(x) <- sample(row.names(x)) ; return(x)})
nQ <- lapply(nQ, function(x){x[names(L$abundance),]})
cl <- makeCluster(3)
clusterExport(cl, list('L', 'nQ'))
nCWM <- clusterApply(cl, L, function(l){
  lapply(nQ, function(q){
    lapply(as.list(c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'Thick')), function(v){
      apply(l, 1, function(x){
        weighted.mean(q[,v], x, na.rm=T)
      })
    })
  })
})
stopCluster(cl)
rm(cl)
nCWM <- lapply(nCWM, function(y){lapply(y,function(x){names(x) <- c('LES', 'SLA', 'WES', 'WD', 'LDMC', 'LA', 'Thick') ; return(x)})})
## Regressions
nCWM.lm <- mapply(function(x,y){
  lapply(y, function(z){
    mapply(function(r,s){
      lm(formula(paste0('s ~ ', as.character(r$terms)[3])), cbind(s,R))
    }, r = x, s = z, SIMPLIFY = F)
  })
}, x = CWM.lm, y = nCWM, SIMPLIFY = F)
rm(nCWM) ; invisible(gc())
## Global F
nFval <- lapply(nCWM.lm, function(lm){lapply(lm, function(y){lapply(y, function(x){summary(x)$fstatistic['value']})})})
nFval <- lapply(nFval, function(x){lapply(x, `[`, names(x[[1]])) ; apply(do.call(rbind, x), 2, as.list)})
nFval <- lapply(nFval, function(f){lapply(f, unlist)})
pval <- 1 - mapply(function(x,y){mapply(function(r,s){rank(c(r,s))[1]/(n+1)}, r = x, s= y)}, x = lapply(as.list(Fval), as.list), y = nFval)
row.names(pval) <- row.names(Fval)
rm(Fval, nFval)
# Partial F
npFval <- lapply(nCWM.lm, function(lm){lapply(lm, function(y){lapply(y, function(x){car::Anova(x)['F value']})})})
npFval <- lapply(npFval, function(x){lapply(x, `[`, names(x[[1]])) ; apply(do.call(rbind, x), 2, as.list)})
npFval <- lapply(npFval, function(f){lapply(f, function(x){do.call('cbind', x)})})
ppval <- mapply(function(x,y){mapply(function(r,s){mapply(function(p,q){rank(c(p,q))[1]/(n+1)}, p = as.list(data.frame(t(r))), q = as.list(data.frame(t(s))))}, r = x, s = y)}, x = pFval, y = npFval, SIMPLIFY = F)
ppval <- lapply(ppval, function(y){lapply(y, function(x){data.frame(t(x))})})
ppval <- lapply(ppval, function(y){data.frame(data.table::rbindlist(y, fill = T))})
ppval <- lapply(ppval, function(y){row.names(y) <- names(CWM.lm$abundance) ; return(y)})
ppval$abundance <- ppval$abundance[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy')]
ppval$abundance$BA <- NA
ppval$`presence-absence` <- ppval$`presence-absence`[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')]
ppval <- lapply(ppval, function(x){1 - x})
rm(pFval, npFval)

# Result tables
kable(regression_table(CWM.lm[[1]], reg, pval[,1], ppval[[1]]))
kable(regression_table(CWM.lm[[2]], reg, pval[,2], ppval[[2]]))
rm(CWM.lm, nCWM.lm, pval, ppval, reg) ; invisible(gc())
```

Table 5: Summary of linear models for traits standardized effect size of community weighted variances. _Linear model results for each trait standardized effect size of community weighted variances species relative abundance after a variable selection by step mesure in both direction with slope, curvature, wetness, and southwesterness (SW), canopy height (Canopy) and basal area (BA). See table 1 for abbreviations. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

**First output is the result of two tails test on communities CWVs for each traits. They are juste here for discussion. But they probably won't be in the final report under this shape.**

```{r CWV, fig.height=4}
# Observed CWVs
CWV <- lapply(names(CWM$abundance), function(v){apply(cbind(data.frame(CWM$abundance[[which(names(CWM$abundance) == v)]]),L$abundance), 1, function(x){sqrt(weighted.mean((Q[,v]-x[1])^2, x[-1], na.rm=T))})})
names(CWV) <- names(CWM$abundance)

# Simulated CWVs 
nL <- rep(list(L$abundance), n)
nL <- lapply(nL,function(l){apply(l, 1, function(x){x[x != 0] <- sample(x[x != 0]) ; return(x)})}) 
nL <- lapply(nL, function(x){t(x)})
nL <- lapply(nL, data.frame)

cl <- makeCluster(3)
clusterExport(cl, list('nL', 'CWM', 'Q'))
nCWM.cwv <- clusterApply(cl, nL, function(l){
  lapply(as.list(names(CWM$abundance)), function(v){
    apply(l, 1, function(x){
      weighted.mean(Q[,v], x, na.rm=T)
    })
  })
})
stopCluster(cl)
nCWM.cwv <- lapply(nCWM.cwv, function(x){names(x) <- names(CWM$abundance) ; return(x)})
nCWV <- mapply(function(l,cwm){
  lapply(names(CWM$abundance), function(v){
    apply(cbind(data.frame(cwm[[which(names(cwm) == v)]]),l), 1, function(x){
      sqrt(weighted.mean((Q[,v]-x[1])^2, x[-1], na.rm=T))
    })
  })
}, l = nL, cwm = nCWM.cwv, SIMPLIFY = F)
nCWV <- lapply(nCWV, function(x){names(x) <- names(CWM$abundance) ; return(x)})
rm(nCWM.cwv, cl, nL) ; invisible(gc())
## Non null CWVs
nCWV <- lapply(nCWV, `[`, names(nCWV[[1]]))
nCWV <- apply(do.call(rbind, nCWV), 2, as.list)
nCWV <- lapply(nCWV, function(x){do.call('cbind', x)})
nCWV <- lapply(nCWV, data.frame)
CWV.pval <- data.frame(mapply(function(x,y){
  mapply(function(p,q){
    rank(c(p,q))[1]/(n+1)
  }, p = as.list(x), q = as.list(data.frame(t(y))))
}, x = CWV, y = nCWV))
CWV.pval.res <- data.frame(inf = apply(CWV.pval, 2, function(x){length(which(x < 0.025))/length(x)}), sup = apply(CWV.pval, 2, function(x){length(which(x > 0.975))/length(x)}))
## CWV SES
CWV.ses <- data.frame(mapply(function(x,y){
  mapply(function(p,q){
    (p - mean(q))/sd(q)
  }, p = as.list(x), q = as.list(data.frame(t(y))))
}, x = CWV, y = nCWV))
CWV.ses.lm <- apply(CWV.ses, 2, function(y){lm(y ~., R)})
CWV.ses.lm <- lapply(CWV.ses.lm, function(x){step(x, direction = 'both', trace = 0)})
CWV.ses.res <- lapply(CWV.ses.lm, function(x){summary(x)$coefficients})
CWV.ses.res <- lapply(CWV.ses.res, data.frame)
CWV.ses.res <- lapply(CWV.ses.res, function(x){x$res <- paste(format(x$Estimate, scientific = T, digits = 2), apply(x[4], 1, stars, ns = '   ')) ; return(x)})
CWV.ses.res <- data.frame(data.table::rbindlist(lapply(CWV.ses.res, function(x){data.frame(t(x[5]))}), fill = T))
CWV.ses.res <- CWV.ses.res[-1]
CWV.ses.res$Slope <- NA
CWV.ses.res <- CWV.ses.res[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')]
CWV.ses.res <- apply(CWV.ses.res, 2, as.character)
row.names(CWV.ses.res) <- names(CWV.ses)
CWV.ses.res[is.na(CWV.ses.res)] <- ''
CWV.ses.res <- data.frame(CWV.ses.res)
CWV.ses.res$R2 <- round(unlist(lapply(CWV.ses.lm, function(x){summary(x)$r.squared})),3)

# Results
barplot(t(CWV.pval.res), las = 2, col = c('darkblue', 'firebrick'), ylim = c(0,1), ylab = 'Proportion of non null communities') ; legend('topright', c('Inferior','Superior'), fill = c('darkblue', 'firebrick'))
kable(CWV.ses.res)
rm(CWV.pval, CWV.pval.res, CWV.ses.res, CWV.ses.lm, nCWV)
```

Table 6: Summary of linear models for traits standardized effect size of coefficient of variation of nearest neighbour distances. _Linear model results for each trait standardized effect size of coefficient of variation of nearest neighbour distances after a variable selection by step mesure in both direction with slope, curvature, wetness, and southwesterness (SW), canopy height (Canopy) and basal area (BA). See table 1 for abbreviations. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

**First output is the result of two tails test on communities CWVs for each traits. They are juste here for discussion. But they probably won't be in the final report under this shape.**

```{r CVNND, fig.height=4}
# Observed CVNND
CVNND <- apply(L$abundance, 1, function(l){apply(Q, 2, function(q){cati::CVNND(rep(q, l), na.rm = T)})})

# Simulated CVNNDs 
cl <- makeCluster(3)
clusterExport(cl, list('nQ', 'L'))
nCVNND <- clusterApply(cl, nQ, function(x){
  apply(L$abundance, 1, function(l){
    apply(x, 2, function(q){
      cati::CVNND(rep(q,l), na.rm = T)
    })
  })
})
stopCluster(cl) ; rm(cl)
rm(nQ) ; invisible(gc)
## Non null CVNNDs
nCVNND <- lapply(nCVNND, function(x){as.list(data.frame(t(x)))})
nCVNND <- lapply(nCVNND, function(x){lapply(x, function(y){names(y) <- colnames(CVNND) ; return(y)})})
nCVNND <- lapply(nCVNND, `[`, names(nCVNND[[1]]))
nCVNND <- apply(do.call(rbind, nCVNND), 2, as.list)
nCVNND <- lapply(nCVNND, function(x){do.call('cbind', x)})
nCVNND <- lapply(nCVNND, data.frame)
CVNND.pval <- data.frame(mapply(function(x,y){
  mapply(function(p,q){
    rank(c(p,q))[1]/(n+1)
  }, p = as.list(x), q = as.list(data.frame(t(y))))
}, x = as.list(data.frame(t(CVNND))), y = nCVNND))
row.names(CVNND.pval) <- colnames(CVNND)
CVNND.pval.res <- data.frame(inf = apply(CVNND.pval, 2, function(x){length(which(x < 0.05))/length(x)}))
## CVNND SES
CVNND.ses <- data.frame(mapply(function(x,y){
  mapply(function(p,q){
    (p - mean(q))/sd(q)
  }, p = as.list(x), q = as.list(data.frame(t(y))))
}, x = as.list(data.frame(t(CVNND))), y = nCVNND))
row.names(CVNND.ses) <- colnames(CVNND)
CVNND.ses.lm <- apply(CVNND.ses, 2, function(y){lm(y ~., R)})
CVNND.ses.lm <- lapply(CVNND.ses.lm, function(x){step(x, direction = 'both', trace = 0)})
CVNND.ses.res <- lapply(CVNND.ses.lm, function(x){summary(x)$coefficients})
CVNND.ses.res <- lapply(CVNND.ses.res, data.frame)
CVNND.ses.res <- lapply(CVNND.ses.res, function(x){x$res <- paste(format(x$Estimate, scientific = T, digits = 2), apply(x[4], 1, stars, ns = '   ')) ; return(x)})
CVNND.ses.res <- data.frame(data.table::rbindlist(lapply(CVNND.ses.res, function(x){data.frame(t(x[5]))}), fill = T))
CVNND.ses.res <- CVNND.ses.res[-1]
CVNND.ses.res$Slope <- NA
CVNND.ses.res <- CVNND.ses.res[c('Slope', 'Curvature', 'Wetness', 'SW', 'Canopy', 'BA')]
CVNND.ses.res <- apply(CVNND.ses.res, 2, as.character)
row.names(CVNND.ses.res) <- names(CVNND.ses)
CVNND.ses.res[is.na(CVNND.ses.res)] <- ''
CVNND.ses.res <- data.frame(CVNND.ses.res)
CVNND.ses.res$R2 <- round(unlist(lapply(CVNND.ses.lm, function(x){summary(x)$r.squared})),3)

# Results
barplot(t(CVNND.pval.res), las = 2, col = c('darkblue'), ylim = c(0,1), ylab = 'Proportion of non null communities') ; legend('topright', c('Inferior'), fill = c('darkblue'))
kable(CVNND.ses.res)
rm(CVNND.pval, CVNND.pval.res, CVNND.ses.res, CVNND.ses.lm, nCVNND) ; invisible(gc())
```

## Composition variation between communities

**Artefacts of phylogenetic tree building to be removed**

```{r PhyloMaker}
library(phylosignal)
library(phytools)
library(phylobase)
path <- system.file('phylogeny', package = 'Uppangala')
source(file.path(path, 'R_codes for function S.PhyloMaker.txt'))
phylo <- read.tree(file.path(path, 'PhytoPhylo.tre'))
nodes <- read.csv(file.path(path, 'nodes.csv'), h = T)
sp <- Species[which(Species$LatinName %in% row.names(PFT_sp)), c('LatinName', 'Genus', 'Family')]
names(sp) <- c('species', 'genus', 'family')
results <- invisible(S.PhyloMaker(sp, phylo, nodes)) # Humboldtia_brunonis unmatched
tree <- results$Scenario.1
rm(phylor, results, modes, sp, S.PhyloMaker, path)
```

Table 7: Summary of Moranâ€™s I statistic and p-values for phylogenetic signal of functional traits. _See table 1 for abbreviations. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r Phylosignal}
data <- PFT_sp
row.names(data) <- gsub(' ', '_', row.names(data), fixed = T)
tips <- row.names(data)[which(is.na(data$WD))]
phy <- drop.tip(tree, tips)
data <- data[phy$tip.label,c(2:5,7)]
p4d <- phylo4d(phy,data)
phyloS <- phyloSignal(p4d, methods = 'I') 
phyloS <- cbind(phyloS$stat, phyloS$pvalue)
names(phyloS) <- c('Moran\'s I', 'p-value')
phyloS$` ` <- lapply(as.list(phyloS$`p-value`), stars, ns = ' ')
kable(phyloS)
rm(data, tips, p4d, phyloS)
```

Variations of both functional and phylogenetic compositions between communities don't significantly differ from null models ($U_{st} = -1.1*10^-3$ with $p-value = 0.114$, $\tau _{st} = 1.8*10^-3$ with $p-value = 0.079$, $\beta _{st} = -8.3*10^-4$ with $p-value = NaN$, and $\pi _{st} = -1.8*10^-3$ with $p-value = 0.247$).  

**Following tables will probably be removed in final report by simply including results in text. They are just here for discussion.**

Table 8: Summary of variation of functional composition between communities. _$U st$ and $\tau st$ metric proposed by @hardy_characterizing_2007 were used to investigate variation of functional composition between communities. Observed values were compared to the one obtained with the null model *"1s"*" suggested by @hardy_testing_2008. The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r Functionnal spatial structure, eval=FALSE, include=FALSE}
library(spacodiR)
mtest <- dist(as(quadrats(), 'SpatialPoints')@coords)

# Observed Hardys
spafun <- lapply(as.list(1:length(Q)), function(i){
  if (length(which(is.na(Q[i]))) > 0)
    q.names <- row.names(Q[-which(is.na(Q[i])),])
  else
    q.names <- row.names(Q)
  sel <- intersect(names(L$abundance), q.names)
  return(spacodi.calc(sp.plot = t(L$abundance[sel]), sp.traits = data.frame(Q[sel,i], row.names = sel), pairwise = T))
})
names(spafun) <- names(Q)
spafun <- lapply(spafun, function(x){x[c('pairwise.Ist','pairwise.Ust', 'pairwise.TAUst')]})
## Mantel values
spafun.mantel <- lapply(spafun, function(t){lapply(t, function(m){vegan::mantel(m, mtest, permutations = 0)$statistic})})

# Simulated Hardys
cl <- makeCluster(3)
clusterExport(cl, list('nQ', 'L', 'spacodi.calc'))
nspafun <- clusterApply(cl, nQ, function(q){
  lapply(as.list(1:length(q)), function(i){
    if (length(which(is.na(q[i]))) > 0)
      q.names <- row.names(q[-which(is.na(q[i])),])
    else
      q.names <- row.names(q)
    sel <- intersect(names(L$abundance), q.names)
    return(spacodi.calc(sp.plot = t(L$abundance[sel]), sp.traits = data.frame(q[sel,i], row.names = sel), pairwise = T))
  })
})
stopCluster()
rm(cl, nQ) ; invisible(gc())
## Simulated mantels


# Result
kable(spafun.res)
```

Table 9: Summary of variation of phylogenetic composition between communities. _$\beta st$ and $\pi st$ metric proposed by @hardy_characterizing_2007 were used to investigate variation of phylogenetic composition between communities. Observed values were compared to a null model randomizing traits among species (permuting raw in `Trait*Species` matrix). The number of asterisk indicate the p-value threshold ( * p-value<0.05, ** p-value <0.01, *** p-value<0.001)._

```{r Phylogenetic spatial structure, eval=FALSE, include=FALSE}
for(i in 1:2) phy[[i]]$tip.label <- gsub('_', ' ', phy[[i]]$tip.label, fixed = T)
for(i in 1:2) phy[[i]]$tip.label <- as.character(l$Sp_Code[match(phy[[i]]$tip.label, row.names(l))])
Lm <- lapply(phy, function(x){Lm[intersect(names(Lm), x$tip.label)]})
phyRD <- lapply(phy, function(x){x$node.label <- NULL ; return(x)})
phyRD <- lapply(phyRD, function(x){rep(list(x), 999)})
phyRD <- lapply(phyRD, function(x){lapply(x, resamp.phy)})
LmRD <- lapply(Lm, function(x){rep(list(x), 999)})
LmRD <- mapply(function(x,y){mapply(function(r,s){r[intersect(names(r), s$tip.label)]}, r = x, s = y, SIMPLIFY = F)}, x = LmRD, y = phyRD, SIMPLIFY = F)
phyRD <- mapply(function(x,y){mapply(function(r,s){drop.tip(r, setdiff(r$tip.label, names(s)))}, r = x, s= y, SIMPLIFY = F)}, x = phyRD, y = LmRD, SIMPLIFY = F)

spaphy <- mapply(function(x,y){spacodi.calc(sp.plot = t(y), phy = x)}, x = phy, y = Lm.l, SIMPLIFY = F)
spaphy <- do.call('rbind.data.frame', lapply(spaphy, function(x){x[1:4]}))

spaphy.l <- mapply(function(x,y){mapply(function(r,s){spacodi.calc(t(r), s)}, r = x, s = y, SIMPLIFY = F)},x = LmRD, y = phyRD, SIMPLIFY = F)
spaphy.l <- lapply(spaphy.l, function(x){lapply(x, function(y){y[1:4]})})
spaphyRD <- list(Ist = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$Ist}))}),
                 Tst = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$Tst}))}),
                 Bst = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$Bst}))}),
                 PIst = lapply(spaphy.l, function(x){unlist(lapply(x, function(y){y$PIst}))}))
pvalues <- mapply(function(obs,rd){
  mapply(function(o,r){rank(c(o, r))[1]/1000}, o = obs, r = rd)
  }, obs = lapply(as.list(spaphy), as.list), rd = spaphyRD)
row.names(pvalues) <- row.names(spaphy)

pvalues <- as.data.frame(pvalues)[3:4]
pvalues$Bst <-  rep(NaN,2)
spaphy.res <- format(spaphy[3:4], scientific = T, digits = 2)
pvalues <- data.frame(apply(pvalues, c(1,2), function(y){paste(y, stars(y, ns = ' '))}))
spaphy.res$Bst <- paste(spaphy.res$Bst, '/', pvalues$Bst)
spaphy.res$PIst <- paste(spaphy.res$PIst, '/', pvalues$PIst)
kable(spaphy.res)
```

# Discussion

## Strategy axes
## Community assembly
## Process scales
## Limits and perspectives

# *Acknowledgement*

# Supplementary materials

**I'm aware that Supplementary materials goes after References (as figure and tables), but it's not possible for the moment with Rmarkdown and knitr.**

## S1: Principal component analysis performed on topgraphical variables

Curvature covary with profile curvature, plan curvature, distance to potential rivers and the PCA first axis. Elevation and wetness are opposed in the principal component analysis and slope and south-westerness doesn't seem to covary much with other variables.

```{r PCA Env}
lambda <- pca.env$sdev * sqrt(nrow(pca.env$scores))
pca.env.var = apply(pca.env$score, 2, var)
plot(t(t(pca.env$scores)/lambda),pch=16, col = 'lightgrey',
     xlab = paste('Axe 1 -', round(pca.env.var[1]/sum(pca.env.var)*100, 2), '%'),
     ylab = paste('Axe 2 -', round(pca.env.var[2]/sum(pca.env.var)*100, 2), '%'))
Hmisc::subplot(function(){
  b <- barplot((pca.env.var / sum(pca.env.var)), las = 2,
          cex.names = 0.7, axes = T, names.arg = NA) ;
  lines(b, bstick(length(pca.env.var)), col = 'red') ;
  legend('topright', c('Eigen values', 'broken stick'), fill = c('grey', 'red'), cex = 0.6,
         box.col = 'white')},
  x=grconvertX(c(0.07,0.37), from='npc'),
  y=grconvertY(c(0.025,0.30), from='npc')
)
par(new=T)
Rot <- t(t(pca.env$loadings)*lambda)
XLIM <- c(-max(abs(Rot[,1])),max(abs(Rot[,1])))
XLIM <- XLIM+(XLIM*0.2)
plot(Rot,col=4,axes=FALSE,xlim=XLIM,ylim=XLIM,pch="",xlab = "", ylab = "")
lines(XLIM, c(0,0), lty = 2, lwd = 2)
lines(c(0,0), XLIM, lty = 2, lwd = 2)
col <- c("#1874CD", "#008B00", "#CD3700", "#9400D3")[c(2, 3, 1, 1, 1,  2, 1, 4)]
arrows (rep(0,nrow(pca.env$loadings)),rep(0,nrow(pca.env$loadings)),
        Rot[,1],Rot[,2],lwd=2,col=col)
legend('topright', c('Elevation', 'Slope', 'Water flow', 'South-West'),
       text.col = col, cex = 1.2)
text (Rot[,1:2], pos = c(2, 2, 2, 1, 1, 3, 3, 4), rownames(Rot),cex=1.2,col=col)
axis (3)
axis (4)
```

Supplementary material S1: Principal component analysis (PCA) performed on topgraphical variables. *Bootom left corner subplot represents the eigen values (grey bars) compare to a broken stick distribution for 8 components (red line). SW stand for southwesterness.*

# References
